function validateCoordinates(lon,lat){if(""===lon&&""===lat||null===lon&&null===lat)return!0;var pattern=/^-?[0-9]{1,3}[.][0-9]+$/;if(!pattern.test(lon)||!pattern.test(lat))return!1;var nlon=parseInt(lon),nlat=parseInt(lat);return nlon>-180&&nlon<180&&nlat>-90&&nlat<90}angular.module("miller",["ui.router","ngResource","ngSanitize","ngCookies","ngTagsInput","mgcrea.ngStrap","monospaced.elastic","LocalStorageModule","pascalprecht.translate","angularLoad","angularLazyImg","ngFileUpload","720kb.socialshare"]).constant("LOCALES",{locales:{en_US:"English"},preferredLocale:"en_US"}).constant("EVENTS",{SAVE:"save",PARAMS_CHANGED:"params_changed",DOWNLOAD:"download",MESSAGE:"message",ERROR:"error",BAD_REQUEST:"bad_request",PERMISSION_DENIED:"permission_denied",RESIZED:"resized",MARKDOWNIT_FULLSIZE:"markdownit_fullsize",MARKDOWNIT_RESOLVE:"markdownit_resolve",MARKDOWNIT_FOCUS:"markdownit_focus",STORY_SET_DOCUMENTS:"story_set_documents",SOCKET_USER_COMMENTED_STORY:"socket_user_commented_story",SOCKET_USER_UNCOMMENTED_STORY:"socket_user_uncommented_story",RANGY_FOCUS:"rangy_focus",RANGY_REFRESH:"rangy_refresh",LANGUAGE_CHANGED:"language_changed"}).config(function($logProvider,RUNTIME){console.log("ENABLE DEBUG:",!!RUNTIME.settings.debug),$logProvider.debugEnabled(!!RUNTIME.settings.debug)}).config(function($locationProvider){$locationProvider.hashPrefix("!")}).config(function(tagsInputConfigProvider,RUNTIME){tagsInputConfigProvider.setDefaults("tagsInput",{replaceSpacesWithDashes:!1,template:RUNTIME["static"]+"templates/partials/tag.input.html"}).setDefaults("autoComplete",{loadOnDownArrow:!0})}).config(function(lazyImgConfigProvider){lazyImgConfigProvider.setOptions({offset:200,errorClass:"error",successClass:"loaded"})}).config(function($translateProvider,RUNTIME){$translateProvider.useSanitizeValueStrategy(null),$translateProvider.useStaticFilesLoader({prefix:RUNTIME["static"]+"locale/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US")}).config(function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("miller")}).config(function($resourceProvider){$resourceProvider.defaults.stripTrailingSlashes=!1}).config(function($httpProvider){$httpProvider.defaults.xsrfCookieName="Miller",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push(function($q,$rootScope,EVENTS){return{responseError:function(rejection){return 400==rejection.status?$rootScope.$emit(EVENTS.BAD_REQUEST,rejection):403==rejection.status&&$rootScope.$emit(EVENTS.PERMISSION_DENIED,rejection),$q.reject(rejection)}}})}).config(function($locationProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}).config(function($stateProvider,$urlRouterProvider,RUNTIME){$urlRouterProvider.otherwise("/"),$stateProvider.state("index.signup",{url:"/",reloadOnSearch:!1,controller:"SignupCtrl",templateUrl:RUNTIME["static"]+"templates/signup.html"}).state("map",{url:"/map",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/map-overview.html"}).state("draft",{url:"/create",reloadOnSearch:!1,controller:"DraftCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html"}).state("upload",{url:"/upload",reloadOnSearch:!1,controller:"UploadCtrl",templateUrl:RUNTIME["static"]+"templates/upload.html"}).state("uploaded",{url:"/uploaded/:storyId",reloadOnSearch:!1,controller:"UploadedCtrl",templateUrl:RUNTIME["static"]+"templates/uploaded.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}).state("writing",{url:"/writing/:storyId?collection",reloadOnSearch:!1,controller:"WritingCtrl",templateUrl:RUNTIME["static"]+"templates/writings.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId,nocache:!0}).$promise}}}).state("writing.live",{url:"/live",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/writings.live.html"}).state("writing.compare",{url:"/compare/:tag",reloadOnSearch:!1,controller:function($scope,version){$scope.version=version},templateUrl:RUNTIME["static"]+"templates/writings.compare.html",resolve:{version:function(StoryGitFactory,$stateParams){return StoryGitFactory.getByGitTag({id:$stateParams.storyId,commit:$stateParams.tag}).$promise}}}).state("writing.compare.diff",{url:"/diff",reloadOnSearch:!1,controller:function($scope,diff,story,StoryGitFactory,$stateParams){$scope.diff=diff.results.diff,$scope.hash=story.version,$scope.$watch("story",function(v){v.version&&v.version!=$scope.hash&&StoryGitFactory.getDiff({id:$stateParams.storyId,commit:$stateParams.tag},function(res){$scope.diff=res.results.diff})},!0)},templateUrl:RUNTIME["static"]+"templates/writings.compare.diff.html",resolve:{diff:function(StoryGitFactory,$stateParams){return StoryGitFactory.getDiff({id:$stateParams.storyId,commit:$stateParams.tag}).$promise}}}).state("writing.compare.preview",{url:"/preview",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/writings.compare.preview.html"}),$stateProvider.state("author",{"abstract":!0,reloadOnSearch:!1,url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}",controller:"AuthorCtrl",templateUrl:RUNTIME["static"]+"templates/author.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}).state("author.publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope){$scope.urls=RUNTIME.stories},templateUrl:RUNTIME["static"]+"templates/author.publications.html"}).state("author.publications.drafts",{url:"/drafts",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{status:"draft",authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}).state("author.publications.bin",{url:"/bin",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{status:"deleted",authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}).state("author.publications.all",{url:"/",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:{authors__slug:author.slug},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),_.each(RUNTIME.routes.publications.writing.concat(RUNTIME.routes.publications.tags),function(d){$stateProvider.state("author.publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(author){return{filters:d.slug?{tags__category__in:["writing","blog"],tags__slug:d.slug,authors__slug:author.slug}:{tags__category__in:["writing","blog"],authors__slug:author.slug},limit:10,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("modifyauthor",{url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}/edit",controller:"AuthorEditCtrl",templateUrl:RUNTIME["static"]+"templates/author.edit.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}),$stateProvider.state("profile",{url:"/profile/{username:[0-9a-zA-Z\\.\\-_]+}",controller:"ProfileCtrl",templateUrl:RUNTIME["static"]+"templates/profile.html",reloadOnSearch:!1,resolve:{profile:function(ProfileFactory,$stateParams){return ProfileFactory.get({username:$stateParams.username}).$promise},authors:function(ProfileFactory,$stateParams){return ProfileFactory.authors({username:$stateParams.username}).$promise}}}).state("profile.publications",{url:"/publications",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(profile){return{filters:{authors__user__username:profile.username},orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),$stateProvider.state("assign",{"abstract":!0,url:"/assign",controller:"AssignCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",reloadOnSearch:!1}),_.each(RUNTIME.routes.assign,function(d){$stateProvider.state("assign."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{status__in:"all"==d.slug?["pending","review","editing","reviewdone"]:[d.slug]},orderby:"-date_last_modified"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.pending(djangoFiltersService(initials)).$promise},model:function(){return"story.pending"},factory:function(StoryFactory){return StoryFactory.pending},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("reviews",{"abstract":!0,url:"/reviews",controller:"ReviewsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html",reloadOnSearch:!1}),_.each(RUNTIME.routes.reviews,function(d){$stateProvider.state("reviews."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters||{},orderby:"-date_last_modified"}},items:function(ReviewFactory,djangoFiltersService,initials){return ReviewFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"review"},factory:function(ReviewFactory){return ReviewFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("reviews.reports",{url:"/reports",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(ReviewFactory){return ReviewFactory.reports(initials).$promise},model:function(){return"report"},factory:function(ReviewFactory){return ReviewFactory.reports},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),$stateProvider.state("review",{url:"/review/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.get({id:$stateParams.id}).$promise}}}).state("review.story",{url:"/story",controller:"StoryCtrl",templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(review){return review.story}}}),$stateProvider.state("report",{url:"/report/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.report({id:$stateParams.id}).$promise}}}),$stateProvider.state("blog",{url:"/blog",reloadOnSearch:!1,"abstract":!0,controller:"BlogCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}),_.each(RUNTIME.routes.blog,function(d){$stateProvider.state("blog."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function($location){var filters="all"!==d.slug?{tags__slug:d.slug}:{tags__category:"blog"},paramFilters={};return $location.$$search&&$location.$$search.filters&&(paramFilters=JSON.parse($location.$$search.filters)),{filters:angular.extend({},filters,paramFilters),orderby:"-date,-date_last_modified"}},items:function(StoryFactory,initials){return StoryFactory.get(initials).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("authors",{url:"/authors",reloadOnSearch:!1,"abstract":!0,controller:"AuthorsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}),_.each([{slug:"all",url:""}].concat(RUNTIME.routes.authors.tags,RUNTIME.routes.authors.writing),function(d){$stateProvider.state("authors."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters?d.filters:{},exclude:{data__num_stories:0},limit:20,orderby:"data__lastname"}},items:function(AuthorFactory,djangoFiltersService,initials){return AuthorFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"author.item"},factory:function(AuthorFactory){return AuthorFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("publications",{url:"/","abstract":!0,reloadOnSearch:!1,controller:"PublicationsCtrl",templateUrl:RUNTIME["static"]+"templates/listofitems.html"}).state("publications.tags",{url:"/tags/:slug",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:{tags__category:"writing"},limit:9,orderby:"-date,-date_last_modified"}},items:function(StoryFactory,$stateParams,djangoFiltersService,initials){return console.log($stateParams.slug),initials.filters.tags__slug__all=[$stateParams.slug],StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),_.each(RUNTIME.routes.publications.all.concat(RUNTIME.routes.publications.status),function(d){$stateProvider.state("publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{filters:d.filters?d.filters:d.slug?{tags__category:"writing",tags__slug:d.slug}:{tags__category:"writing"},limit:9,orderby:d.orderby?d.orderby:"all"===d.slug?"featured":"-date,-date_last_modified",availabileOrderby:_.concat("all"===d.slug?[{label:"featured",value:"featured"}]:[],[{label:"issue",value:"data__issue,-date"},{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"lastmod",value:"-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}]),description:"home-description"}},items:function(StoryFactory,djangoFiltersService,initials){return StoryFactory.get(djangoFiltersService(initials)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}})}),$stateProvider.state("search",{url:"/search",controller:"SearchCtrl",reloadOnSearch:!1,"abstract":!0,templateUrl:RUNTIME["static"]+"templates/search.html"}).state("search.story",{url:"?q",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(StoryFactory,$stateParams,initials,djangoFiltersService){return StoryFactory.search(djangoFiltersService($stateParams)).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.search},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),$stateProvider.state("story",{url:"/story/:postId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.postId}).$promise}}}).state("storygit",{url:"/story/:id/git/:commit",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryGitFactory,$stateParams){return StoryGitFactory.getByGitTag({id:$stateParams.id,commit:$stateParams.commit}).$promise}}}).state("story.story",{url:"/:chapterId",controller:"ChapterCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.chapter.html",resolve:{chapter:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.chapterId}).$promise}}}),$stateProvider.state("notifications",{"abstract":!0,url:"/notifications",controller:"NotificationsCtrl",templateUrl:RUNTIME["static"]+"templates/notifications.html"}).state("notifications.activities",{url:"/activities",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{initials:function(){return{}},items:function(PulseFactory,initials){return PulseFactory.activities(initials).$promise},model:function(){return"action"},factory:function(PulseFactory){return PulseFactory.get},description:function(PageFactory,initials){return initials.description?PageFactory.get({name:initials.description}).$promise:null}}}),$stateProvider.state("page",{url:"/:name",controller:"PageCtrl",templateUrl:RUNTIME["static"]+"templates/md.html",resolve:{page:function(PageFactory,$stateParams){return PageFactory.get({name:$stateParams.name}).$promise}}})}).run(function($window,$log,RUNTIME){$log.log("☕ app run, version: Kidding Tiger; analytics:",RUNTIME.settings.analytics?"enabled":"disabled"),RUNTIME.settings.analytics&&$window.ga("create",RUNTIME.settings.analytics||"UA-XXXXXXXX-X","auto")}),angular.module("miller").filter("prefixTemplate",function(RUNTIME){return function(input){return RUNTIME["static"]+input}}).filter("bibtex",function(){return function(text){return text?text.replace(/[\{\}]/g,""):""}}).filter("inArray",function(){return function(arr,value){return Array.isArray(arr)&&arr.indexOf(value)!==-1}}).filter("smartUrl",function(){return function(text){return(text||"").replace(/^https?:\/\/(www)?\.?([^\/]*)\/(.*)$/,function(m,www,domain,path){return domain+"/..."+path.substr(-25)})}}).filter("multilanguage",function($rootScope){return function(obj){return"object"!=typeof obj?obj:obj[$rootScope.language]}}).filter("tokenize",function(){return function(text,maxwords){if(!text)return"";var words=text.split(/(?!=\.\s)\s/),sentence=_.take(words,maxwords).join(" ");return sentence.length<text.length&&(sentence.match(/\?\!\.$/)||(sentence+=" "),sentence+="..."),sentence}}).filter("coverage",function(){return function(cover,hifi){var url,_hifi="hifi"==hifi;return"object"!=typeof cover?"":url=cover.data?_hifi?cover.data.media_url||_.get(cover,"data.urls.Publishable")||cover.data.thumbnail_url||cover.data.preview||cover.data.url||cover.attachment||cover.snapshot:cover.data.thumbnail_url||cover.data.preview||_.get(cover,"data.urls.Preview")||cover.snapshot||cover.attachment||cover.data.url:_hifi?cover.attachment||cover.snapshot:cover.snapshot||cover.attachment}}).filter("substr",function(){return function(text,start,end){return text.substr(start,end)}}).filter("statetoclass",function(){return function(text){return(text||"").split(".").join(" ")}}).filter("quotes",function(){return function(text,language){var st={lq:{en_US:{"«":"“",'"':"“"},fr_FR:{"“":"«",'"':"«"}},rq:{en_US:{"»":"”",'"':"”"},fr_FR:{"”":"»",'"':"»"}}};return st.rq[language]?(text||"").replace(/([\s,;\?\.\!\[\]\(\)])(["«“])([^"»”]*)(["»”])([\s,;\?\.\!\[\]\(\)])/g,function(m,left,lq,quote,rq,right){return[left,st.lq[language][lq]||lq,quote,st.rq[language][rq]||rq,right].join("")}):text}}).filter("slugify",function(){return function(text){for(var strip=/[^\w\s-]/g,hyphen=/[-\s]+/g,slug=text.toLowerCase(),map={from:"àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;",to:"aaaaaeeeeiiiiooooouuuunc------"},i=0,j=map.from.length;i<j;i++)slug=slug.replace(new RegExp(map.from.charAt(i),"g"),map.to.charAt(i));return slug.replace(strip,"").trim().replace(hyphen,"-")}}),angular.module("miller").service("parseHeaderFilename",function(){return function(headers){var header=headers("content-disposition"),result=header.split(";")[1].trim().split("=")[1];return result.replace(/"/g,"")}}).factory("AuthFactory",function($resource){return $resource("/auth/:fn/",{},{login:{method:"POST",params:{fn:"login"}},register:{method:"POST",fn:"register"}})}).factory("CrossRefFactory",function($http){return{search:function(query,page,rows){return $http.get("http://search.crossref.org/dois",{params:{q:query,header:"true",page:page||1,rows:rows||8}})}}}).factory("StoryFactory",function($resource,parseHeaderFilename){return $resource("/api/story/:id/:fn/",{},{update:{method:"PUT"},publish:{method:"POST",params:{fn:"publish"}},search:{method:"GET",params:{fn:"search"}},patch:{method:"PATCH"},getComments:{params:{fn:"comments"},method:"GET"},featured:{params:{fn:"featured"},method:"GET"},getNeighbors:{params:{fn:"neighbors"},method:"GET"},pending:{params:{fn:"pending"},method:"GET"},download:{params:{fn:"download"},method:"GET",responseType:"arraybuffer",transformResponse:function(data,headers){return{data:data,filename:parseHeaderFilename(headers)}}}})}).factory("StoryDOIMetadataFactory",function($resource){return $resource("/api/story/:id/doi/:fn/",{},{getMetadata:{method:"GET",params:{fn:"metadata"}},updateMetadata:{method:"POST",params:{fn:"metadata"}}})}).factory("StoryGitFactory",function($resource,parseHeaderFilename){return $resource("/api/story/:id/git/:fn/:commit/",{},{getByGitTag:{params:{fn:"tag"},method:"GET"},getDiff:{params:{fn:"diff"},method:"GET"},saveVersion:{params:{fn:"tag"},method:"POST"}})}).factory("StoryTagsFactory",function($resource){return $resource("/api/story/:id/tags/",{},{update:{method:"PUT"}})}).factory("StoryDocumentsFactory",function($resource){return $resource("/api/story/:id/documents/",{},{update:{method:"PUT"}})}).factory("ProfileFactory",function($resource){return $resource("/api/profile/:username/:related",{},{authors:{method:"GET",params:{related:"authors/"}},update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("UserFactory",function($resource){return $resource("/api/user/:fn",{},{getReviewers:{method:"GET",params:{fn:"reviewers"}}})}).factory("PulseFactory",function($resource){return $resource("/api/pulse/:fn/",{},{activities:{method:"GET"},unread:{method:"GET",params:{fn:"unread"}},noise:{method:"GET",params:{fn:"noise"}},reset:{method:"POST",params:{fn:"reset"}}})}).factory("CollectionFactory",function($resource){return $resource("/api/collection/:id/",{},{})}).factory("AuthorFactory",function($resource){return $resource("/api/author/:slug/:fn/",{},{update:{method:"PUT"},patch:{method:"PATCH"},hallOfFame:{method:"GET",params:{fn:"hallOfFame"}}})}).factory("DocumentFactory",function($resource){return $resource("/api/document/:id/:fn",{},{update:{method:"PUT"},suggest:{method:"GET",params:{fn:"suggest"}},oembed:{method:"GET",params:{fn:"oembed/"}}})}).factory("MentionFactory",function($resource){return $resource("/api/mention/:id/")}).factory("CaptionFactory",function($resource){return $resource("/api/caption/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("CommentFactory",function($resource){return $resource("/api/comment/:id/",{},{})}).factory("ReviewFactory",function($resource){return $resource("/api/review/:id/:fn",{},{patch:{method:"PATCH"},close:{method:"POST",params:{fn:"close/"}},report:{method:"GET",params:{fn:"report/"}},reports:{method:"GET",params:{fn:"reports/"}}})}).factory("TagFactory",function($resource){return $resource("/api/tag/:id/:fn/",{},{update:{method:"PUT"},hallOfFame:{method:"GET",params:{fn:"hallOfFame"}}})}).factory("PageFactory",function($resource,RUNTIME){return $resource("/api/page/:name/",{},{})}).service("QueryParamsService",function($filter){return function(queryparams){var params={};return queryparams.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=decodeURIComponent(value)}),params}}).service("djangoFiltersService",function($location){return function(params){var _params=angular.copy(params),qs=$location.search();if(qs.filters)try{_params.filters=JSON.stringify(angular.merge(_params.filters||{},JSON.parse(qs.filters||"{}"))),_params.exclude=JSON.stringify(angular.merge(_params.exclude||{},JSON.parse(qs.exclude||"{}")))}catch(e){$log.warn("ItemsCtrl @EVENTS.PARAMS_CHANGED wrong filters provided!")}return qs.orderby&&(_params.orderby=qs.orderby),_params}}).service("bibtexService",function($filter){return function(json){}}).service("markdownItLanguageService",function($filter){return function(value,language){var candidate;return value?(candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value(),candidate["lang:"+language]?candidate["lang:"+language]:value):""}}).service("markdownItChaptersService",function($filter,markdownItLanguageService){return function(value,language){var links=[],linkIndex=0,md=new window.markdownit;return md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim();0===url.indexOf("voc/")&&(linkIndex++,links.push({_index:linkIndex,citation:tokens[idx+1].content,slug:url.replace("voc/","").split(",")[0],type:"chapter"}))},md.render(markdownItLanguageService(value,language)),links}}).service("markdownItService",function($filter){return function(value,language,disableLazyPlaceholders){var results,md=new window.markdownit({html:!0}),linkIndex=0;if(results={md:value,html:"",ToC:[],docs:[],paragraphs:0,footnotes:{}},md.use(window.markdownitFootnote).use(window.markdownitContainer,"profile").use(window.markdownitContainer,"profile-committee").use(window.markdownitContainer,"profile-others").use(window.markdownitContainer,"abstract").use(window.markdownItAttrs),md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim(),klass=tokens[idx].attrGet("class")||"";if(0===url.indexOf("doc/")){var doc=url.trim().replace("doc/","").replace(/\//g,"-").split(",")[0];return linkIndex++,results.docs.push({_index:linkIndex,_type:tokens[idx+1].content.length?"doc":"block-doc",citation:tokens[idx+1].content,slug:doc}),disableLazyPlaceholders||tokens[idx+1].content.length?'<a id="item-'+linkIndex+'" class="special-link'+(tokens[idx+1].content.length?"":" block")+'" name="'+doc+'" ng-click="focus(\''+linkIndex+"','"+url+"', 'doc')\"><span hold slug=\""+doc+'" type="doc"  class="anchor-wrapper"></span><span class="icon icon-eye"></span>':'<span id="item-'+linkIndex+'" class="lazy-placeholder '+klass+'" type="doc" lazy-placeholder="'+doc+'"></span><a>'}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var ind in terms)linkIndex++,results.docs.push({_index:linkIndex,_type:"voc",citation:tokens[idx+1].content,slug:terms[ind],type:"glossary"});return tokens[idx].attrSet("class","glossary"),'<a id="item-'+linkIndex+'" class="special-link glossary"  ng-click="focus(\''+linkIndex+'\')"><span hold slug="'+terms[0]+'" type="voc" class="anchor-wrapper"></span><span class="icon icon-arrow-right-circle"></span>'+(disableLazyPlaceholders||tokens[idx+1].content.length?"":"&nbsp;")}return'<a href="'+url+'" target="_blank">'},md.renderer.rules.table_open=function(tokens,idx){return'<table class="table">'},md.renderer.rules.heading_open=function(tokens,idx){var text=tokens[idx+1].content,h={text:text,level:tokens[idx].tag.replace(/[^\d]/g,""),slug:$filter("slugify")(text)};return results.ToC.push(h),"<"+tokens[idx].tag+'><a name="'+h.slug+'" id="h-'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'},console.log("rules",md.renderer.rules),md.renderer.rules.image=function(tokens,idx){var src=tokens[idx].attrGet("src"),title=tokens[idx].attrGet("title"),alt=tokens[idx].content;return 0===alt.indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},md.renderer.rules.footnote_anchor=function(tokens,idx,options,env,slf){var caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span class="footnote-anchor">'+caption.replace(/[\[\]]/g,"")+"</span>"},md.renderer.rules.footnote_ref=function(tokens,idx,options,env,slf){var id=slf.rules.footnote_anchor_name(tokens,idx,options,env,slf),caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return linkIndex++,results.docs.push({_index:linkIndex,_type:"footnote",id:id,caption:caption}),"<span  ng-click=\"focus('"+linkIndex+'\')" id="item-'+linkIndex+'" class="footnote-ref"><span class="footnote"><a>'+caption+"</a></span></span>"},value.replace(/[\n\s\r]*---[\n\r]((.|[\n\r])+)\.{3}[\n\s\r]*/m,function(d,m){return results.meta=m,""}),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]?value=candidate["lang:"+language]:candidate["lang:en_US"]&&(value=candidate["lang:en_US"]),value=$filter("quotes")(value,language)}return results.html=md.render(value),results}}).service("extendItem",function($injector){return function(item,model,options){return"story"==model?$injector.get("extendStoryItem")(item,options.language):item}}).service("extendStoryItem",function(markdownItChaptersService){return function(story,language){story._chapters=[],story._biography=null,story._isBiography=!1,story._isCollection=!1,story._tags={};for(var i=0,j=story.tags.length;i<j;i++){if("writing"==story.tags[i].category&&"collection"==story.tags[i].slug){var links=markdownItChaptersService(story.contents,language),stories=_.keyBy(story.stories,"slug");story._chapters=_(links).map(function(d){return stories[d.slug]?stories[d.slug]:void console.warn("chapter with slug: ",d.slug,"was not found in related stories!!!")}).compact().value(),story._isCollection=!0}else"writing"==story.tags[i].category&&"biography"==story.tags[i].slug&&(story._isBiography=!0);story._tags[story.tags[i].category]||(story._tags[story.tags[i].category]={}),story.tags[i].status&&(story._tags[story.tags[i].category][story.tags[i].id]=story.tags[i])}if(story.data._ordering||(story.data._ordering={}),story.data._ordering.authors){var authors=_.keyBy(story.authors,"id");story.authors=story.data._ordering.authors.map(function(d){return authors[d]})}else story.data._ordering.authors=_.map(story.authors,"id");if(story.data._ordering.tags)for(var category in story.data._ordering.tags)story._tags[category]=_(story.data._ordering.tags[category]).uniq().map(function(d){return!(!story._tags[category]||!story._tags[category][d])&&story._tags[category][d]}).filter(function(d){return d!==!1}).value(),story.tags=_(story._tags).map(_.identity).flatten().compact().value();else story.data._ordering.tags=_.mapValues(story._tags,function(d){return _.map(d,"id")});return story.covers=story.covers.filter(function(doc){return story._isBiography&&"entity"==doc.type&&"person"==doc.data.type&&(story._biography=doc),"entity"!=doc.type}),story._isBiography=!!story._biography&&!!story._biography.data.activities&&!!story._biography.data.activities.length,story;
}}).factory("metadataFactory",function($log){return{parse:function(story){$log.info("[service] metadata.parse")},create:function(story){}}}).service("storyCart",function(){this.selectedItems="selectedArticles"in window.localStorage?JSON.parse(window.localStorage.getItem("selectedArticles")):[];var self=this,updateLocalStorage=function(){window.localStorage.setItem("selectedArticles",JSON.stringify(self.selectedItems))};this.count=function(){return this.selectedItems.length},this.isEmpty=function(){return 0===this.count()},this.selectItem=function(item){this.selectedItems.push({id:item.id,slug:item.slug,data:item.data,title:item.title,authors:item.authors}),updateLocalStorage()},this.deselectItem=function(item){this.selectedItems.splice(this.selectedItems.findIndex(function(e){return e.id===item.id}),1),updateLocalStorage()},this.isItemSelected=function(id){return this.selectedItems.findIndex(function(e){return e.id===id})!==-1},this.clearList=function(){this.selectedItems=[],updateLocalStorage()}}),angular.module("miller").controller("AssignCtrl",function($scope,$log,$modal,ReviewFactory,UserFactory,RUNTIME,EVENTS){$log.log("⏱ AssignCtrl ready");var selectTagfn=$scope.selectSingleTag;$scope.selectTag=function(tag){selectTagfn(tag,"status")},$scope.isTagActive=function(tag){return $scope.filters.status&&$scope.filters.status===tag};var addReviewModal,finalDecisionModal;$scope.mainStatename="assign.all",$scope.availableRoutes=[{state:"assign",urls:RUNTIME.routes.assign}],$scope.availabileOrderby=[{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.suggestReviewer=function(query,options){$log.log("⏱ AssignCtrl -> suggestReviewer",query,options);return UserFactory.getReviewers({}).$promise.then(function(response){return response.results})},$scope.addReview=function(story){$log.log("⏱ AssignCtrl -> open addReviewModal."),addReviewModal=$modal({scope:$scope,controller:"AddReviewModalCtrl",resolve:{story:function(){return story}},templateUrl:RUNTIME["static"]+"templates/partials/modals/add-review.html",id:"addReview"}),addReviewModal.$promise.then(addReviewModal.show)},$scope.finalDecision=function(story){$log.log("⏱ AssignCtrl -> open finalDecisionModal."),finalDecisionModal=$modal({scope:$scope,controller:"FinalDecisionModalCtrl",resolve:{story:function(){return story}},templateUrl:RUNTIME["static"]+"templates/partials/modals/final-decision.html",id:"addReview"}),finalDecisionModal.$promise.then(finalDecisionModal.show)},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ AssignCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("AuthorCtrl",function($scope,$log,author){$scope.isMe=!!author.profile&&$scope.user.username==author.profile.username,$log.log("AuthorCtrl ready, author:",author.fullname),$scope.author=author}).controller("AuthorEditCtrl",function($scope,$state,$log,AuthorFactory,author,EVENTS){$log.log("AuthorEditCtrl ready, author:",author,$scope.previousState),$scope.author=author,$scope.isSaving=!1,$scope.save=function(){return $log.log("AuthorEditCtrl -> save()",$scope.author),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,void AuthorFactory.patch({slug:$scope.author.id},{fullname:[$scope.author.data.firstname,$scope.author.data.lastname].join(" "),data:$scope.author.data,affiliation:$scope.author.affiliation},function(res){$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.isSaving=!1,$scope.previousState.from&&$scope.previousState.from.name&&$scope.previousState.from.name.length?$state.go($scope.previousState.from.name,$scope.previousState.fromParams):$state.go("author.publications.all",{slug:$scope.author.slug})},function(err){$log.error("error:",err.data),$scope.isSaving=!1}))}}),angular.module("miller").controller("AuthorsCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ AuthorsCtrl ready"),$scope.mainStatename="authors.all",$scope.availableRoutes=[{state:"authors",urls:RUNTIME.routes.authors.writing},{state:"authors",urls:RUNTIME.routes.authors.tags}],$scope.availabileOrderby=[{label:"publishedrecently",value:"-stories__date"},{label:"lastnameaz",value:"data__lastname"},{label:"lastnameza",value:"-data__lastname"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"lastnameaz"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ AuthorsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("BlogCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ BlogCtrl ready"),$scope.mainStatename="blog.all";var selectTagfn=$scope.selectSingleTag;$scope.selectTag=function(tag){selectTagfn(tag,"tags__slug")},$scope.isTagActive=function(tag){return $scope.filters.tags__slug&&$scope.filters.tags__slug===tag},$scope.availableRoutes=[{state:"blog",urls:RUNTIME.routes.blog}],$scope.availabileOrderby=[{label:"newest",value:"-date,-date_last_modified"},{label:"oldest",value:"date,-date_last_modified"},{label:"titleaz",value:"title"},{label:"titleza",value:"-title"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ BlogCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("ChapterCtrl",function($log,$scope,$timeout,chapter,EVENTS){$scope.chapter=chapter,$scope.chapter.isWritable=$scope.hasWritingPermission($scope.user,$scope.chapter),$scope.isChapter=!0,$scope.setDocuments=function(items){var documents=[];$scope.sidedocuments=0,documents=_(items).map(function(d){for(var i=0;i<chapter.documents.length;i++)if(chapter.documents[i].slug==d.slug)return $scope.sidedocuments+=d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},chapter.documents[i]);for(i=0;i<chapter.stories.length;i++)if(chapter.stories[i].slug==d.slug)return $scope.sidedocuments+=d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},chapter.stories[i]);return d}).value(),$timeout(function(){$log.log("ChapterCtrl > setDocuments items n.:",documents.length,$scope.sidedocuments>0?"WITH":"NO","sideDocuments."),documents.length>0&&$scope.$emit(EVENTS.STORY_SET_DOCUMENTS,documents)},1e3)}}),angular.module("miller").controller("CollectionCtrl",function($scope,$rootScope,$log,collection,EVENTS,StoryFactory,markdownItChaptersService){$log.log("CollectionCtrl ready",$scope.user.username,$scope.language),$scope.collection=collection,$scope.collection.isWritable=$scope.hasWritingPermission($scope.user,$scope.collection),collection.covers.length&&($scope.collection.cover=_.first(collection.covers)),$scope.setStatus=function(status){$log.debug("CollectionCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.collection.id},{title:$scope.collection.title,status:status},function(res){$scope.collection.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))};var links=markdownItChaptersService(collection.contents,$scope.language),stories=_.keyBy(collection.stories,"slug");$scope.chapters=_(links).map(function(d){return stories[d.slug]?stories[d.slug]:void $log.warn("chapter with slug: ",d.slug,"was not found in related stories!!!")}).compact().value()}),angular.module("miller").controller("CoreCtrl",function($rootScope,$transitions,$scope,$log,$location,$window,$anchorScroll,$state,$modal,$alert,localStorageService,$filter,$translate,$timeout,StoryFactory,DocumentFactory,TagFactory,UserFactory,AuthorFactory,storyCart,RUNTIME,EVENTS){$log.log("🍔 CoreCtrl ready, user:",RUNTIME.user.username,RUNTIME),$scope.user=$rootScope.user=RUNTIME.user,$scope.userGroups=_.map(RUNTIME.user.profile.groups,"name"),$scope.user.is_reviewer=$scope.userGroups.indexOf("reviewers")!=-1,$scope.user.is_chief_reviewer=$scope.userGroups.indexOf("chief-reviewers")!=-1,$scope.settings=RUNTIME.settings,$rootScope.page="author.publications.all",$scope.hasToC=!1,$scope.ToCEnabled=!1,$scope.stopStateChangeStart=!1,$scope.toggleTableOfContents=function(e){$scope.hasToC=!$scope.hasToC,e&&e.stopImmediatePropagation()},$scope.locationPath="",$scope.toggleStopStateChangeStart=function(value){$log.debug("🍔 CoreCtrl > toggleStopStateChangeStart value:",value,"- current:",$scope.stopStateChangeStart),$scope.stopStateChangeStart="boolean"==typeof value?value:!$scope.stopStateChangeStart},$scope.setToC=function(ToC){$log.log("🍔 CoreCtrl > setToC data:",ToC),$scope.ToC=ToC},$scope.disableToC=function(){$scope.ToCDisabled=!0},$scope.search=function(searchquery){$log.log("🍔 CoreCtrl > search() searchquery:",searchquery),$state.go("search.story",{q:searchquery})},$scope.setDocuments=function(documents){$log.log("🍔 CoreCtrl > setDocuments items n.:",documents.length,documents),$scope.documents=_.uniq(documents,"id")},$scope.$on(EVENTS.STORY_SET_DOCUMENTS,function(e,documents){$log.log("🍔 CoreCtrl @EVENTS.STORY_SET_DOCUMENTS setDocuments documents n.:",documents.length),$scope.setDocuments(documents)}),$rootScope.resolve=function(slug,type,callback){if("voc"==type)$log.log("🍔 CoreCtrl > $scope.resolve [requesting] voc slug:",slug),StoryFactory.get({id:slug},callback);else{var matching=$scope.documents.filter(function(d){return d.slug==slug});matching.length?($log.log("🍔 CoreCtrl > $scope.resolve [cached] doc slug:",slug),callback(matching[0])):($log.log("🍔 CoreCtrl > $scope.resolve [requesting] doc slug:",slug),DocumentFactory.get({id:slug},callback))}},$scope.save=function(){$log.log("🍔 CoreCtrl > @SAVE ..."),$scope.$broadcast(EVENTS.SAVE)},$scope.params={},$scope.filters={},$scope.changeOrderby=function(orderby){$log.log("🍔 CoreCtrl > @changeOrderby ..."),$location.search("orderby",orderby)};var setNewLocation=function(){var params=$location.search();"orderby"in params&&params.orderby&&"featured"!==params.orderby?$location.search("filters",angular.equals({},$scope.filters)?null:JSON.stringify($scope.filters)):(params.orderby="-date,-date_last_modified",params.filters=JSON.stringify($scope.filters),$location.search(params))};$scope.toggleFilter=function(key,value){$log.log("🍔 CoreCtrl > @setFilters ..."),$scope.filters[key]==value?delete $scope.filters[key]:$scope.filters[key]=value,setNewLocation()},$scope.selectTag=function(tag,filterType){void 0===filterType&&(filterType="tags__slug__and"),filterType in $scope.filters||($scope.filters[filterType]=[]),$scope.filters[filterType].indexOf(tag)!==-1?($scope.filters[filterType].splice($scope.filters[filterType].indexOf(tag),1),0===$scope.filters[filterType].length&&delete $scope.filters[filterType]):$scope.filters[filterType].push(tag),setNewLocation()},$scope.selectSingleTag=function(tag,filterType){void 0!==filterType&&(filterType in $scope.filters&&$scope.filters[filterType]===tag?delete $scope.filters[filterType]:$scope.filters[filterType]=tag,setNewLocation())},$scope.isTagActive=function(tag){return $scope.filters.tags__slug__and&&$scope.filters.tags__slug__and.findIndex(function(e){return e===tag})!==-1},$scope.isSDGActive=function(tag){return!$scope.filters.tags__slug__and||$scope.filters.tags__slug__and&&$scope.filters.tags__slug__and.findIndex(function(e){return e===tag})!==-1},$scope.download=function(){$log.log("🍔 CoreCtrl > @DOWNLOAD ..."),$scope.$broadcast(EVENTS.DOWNLOAD)},$scope.update=function(key,value){$log.log("🍔 CoreCtrl > @UPDATE ",key,":",value," ...");var _d={};_d[key]=value,$scope.$broadcast(EVENTS.UPDATE,_d)},$scope.lock=function(){$scope.locked=!0,$log.log("🍔 CoreCtrl > lock .............")},$scope.unlock=function(msg){$scope.locked=!1,$log.log("🍔 CoreCtrl > unlock ............. message:",msg)},$scope.suggestTags=function(query,options,has_create){$log.log("🍔 CoreCtrl -> suggestTags",query,options);var filters=options||{},params={filters:JSON.stringify(filters),limit:999};return query.trim().length>2&&(params.q=query),TagFactory.get(params).$promise.then(function(response){return console.log(response.results),has_create?response.results.concat([{type:"__new__",name:"createnew",id:"createnew",query:query}]):response.results})},$transitions.onStart({},function($transition$){var from=$transition$.$from().name,to=$transition$.$to().name;if($log.log("🍔 CoreCtrl @stateChangeStart new:",to,"- previous:",$scope.state),"login"===to&&$scope.user.short_url)return $log.warn("... cannot switch to login, user already logged in:",$scope.user.username),void($scope.state&&"login"!=$scope.state?$state.go($scope.state):$state.go("author.publications.all"));if($scope.stopStateChangeStart===!0&&from.split(".")[0]!==to.split(".")[0]){var answer=confirm("Are you sure you want to leave this page?");if(!answer)return!1}}),$transitions.onSuccess({},function($transition$){var updatedParams=$transition$.paramsChanged();if(1!==Object.keys(updatedParams).length||"#"!==Object.keys(updatedParams)[0]||null===updatedParams["#"]){var h=$location.hash();$scope.ToC=[],$scope.documents=[],$scope.state=$transition$.$to().name,$scope.previousState={from:$transition$.$from(),fromParams:$transition$.$from().params},$rootScope.page=_.compact($scope.state.split(".").filter(function(d){return["page","all","story"].indexOf(d)==-1}).concat([$state.params.name,$state.params.storyId,$state.params.postId])).join(" - "),$scope.absoluteUrl=$rootScope.absoluteUrl=$state.href($state.current.name,$state.params,{absolute:!0}),$log.debug("🍔 CoreCtrl @stateChangeSuccess - name:",$scope.state,"- page:",$rootScope.page),h&&h.length&&$timeout($anchorScroll,0),$scope.toggleStopStateChangeStart(!1),$window.ga("send","pageview",$location.path()),window.scrollTo(0,0)}}),$rootScope.getTagRoute=function(tag){return'/?orderby=-date,-date_last_modified&filters={"tags__slug__and":["'+tag.slug+'"]}'},$rootScope.getBlogRoute=function(tag){return'/blog?orderby=-date,-date_last_modified&filters={"tags__slug":"'+tag.slug+'"}'},$scope.setHash=function(hash){$location.hash(hash)},$scope.changeLanguage=function(key){$scope.language=key,$rootScope.language=key,localStorageService.set("lang",$scope.language),$log.log("🍔 CoreCtrl -> changeLanguage language:",$scope.language),$translate.use(key),$scope.$broadcast(EVENTS.LANGUAGE_CHANGED,$scope.language)},$scope.isWithoutAuthors=function(story){return 0!==story.authors.length},$scope.hasWritingPermission=function(user,story){return!!user.username&&user.username.length>0&&(user.is_staff||story.owner.username==user.username||_.map(story.authors,"profile.user.username").indexOf(user.username)!==-1)};var fullsizeModal=$modal({scope:$scope,template:RUNTIME["static"]+"templates/partials/modals/fullsize.html",id:"dii",show:!1});$scope.$on("modal.hide",function(e,modal){$scope.fullsized=null}),$rootScope.fullsize=function(slug,type){if($log.log("🍔 CoreCtrl -> fullsize -slug:",slug,"-type:",type),"voc"==type)$state.go("story",{postId:slug});else{for(var _isCached=!1,i=0,j=$scope.documents.length;i<j;i++)if(slug==$scope.documents[i].slug){$scope.fullsized=$scope.documents[i],fullsizeModal.$promise.then(fullsizeModal.show),_isCached=!0;break}_isCached||($log.log("🍔 CoreCtrl -> fullsize, doc slug:",slug,"not found in documents, loading..."),DocumentFactory.get({id:slug},function(res){$scope.fullsized=res,fullsizeModal.$promise.then(fullsizeModal.show)}))}},$scope.suggestUser=function(query,options){$scope.user.is_staff||$log.warn("🍔 CoreCtrl -> suggestUser is avaialble to staff only, you should not be here."),$log.log("🍔 CoreCtrl -> suggestUser",query,options);var filters=options||{};return UserFactory.get({filters:JSON.stringify(filters)}).$promise.then(function(response){return response.results})},window.onbeforeunload=function(event){if($scope.state&&["draft","writing"].indexOf($scope.state)!==-1){var message="Sure you want to leave?";return"undefined"==typeof event&&(event=window.event),event&&(event.returnValue=message),message}},$scope.setOG=function(OG){$log.debug("CoreCtrl -> setOG",OG),$rootScope.OG=angular.extend({title:"",description:"",image:""},OG||{})},$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("🍔 CoreCtrl @locationChangeSuccess",path,$location),$scope.qs=$location.search();try{$scope.filters=$scope.qs.filters?JSON.parse($scope.qs.filters):{},$log.log("🍔 CoreCtrl load filters: ",$scope.filters)}catch(ex){$log.warn("🍔 CoreCtrl couldn't load filters",ex),$scope.filters={}}$scope.locationPath=path,$scope.path=$location.path(),$scope.searchquery=$scope.qs.q,$scope.fullsized&&($scope.fullsized=null,fullsizeModal.hide()),$scope.$broadcast(EVENTS.PARAMS_CHANGED,$scope.qs)}),$scope.setLocationFilter=function(field,value){$location.search(field,value)},$scope.removeLocationFilter=function(field){$location.search(field,null)},$scope.calculateBounds=function(event){$rootScope.isASmallScreen=$window.innerWidth<992},$rootScope.$on(EVENTS.BAD_REQUEST,function(e,rejection){$log.warn("@BAD_REQUEST."),400==rejection.status&&$alert({placement:"top",title:"form errors",animation:"bounceIn",content:_(rejection.data).map(function(d,k){return"<div><b>"+k+"</b>: "+d+"</div>"}).value().join(""),show:!0,type:"error"})}),$rootScope.$on(EVENTS.PERMISSION_DENIED,function(e,rejection){$log.warn("@PERMISSION_DENIED. Should redirect",$location.absUrl())});var timer_event_message;$scope.messageError=!1;var makeMessage=function(e,message,popuptime){$log.log("🍔 CoreCtrl @MESSAGE",message),$scope.message=message,timer_event_message&&$timeout.cancel(timer_event_message),timer_event_message=$timeout(function(){$scope.message=null},popuptime)};$scope.$on(EVENTS.MESSAGE,function(e,message){$scope.messageError=!1,makeMessage(e,message,4e3)}),$scope.$on(EVENTS.ERROR,function(e,message){$scope.messageError=!0,makeMessage(e,message,4e3)}),angular.element($window).bind("keydown",function(event){if(event.ctrlKey||event.metaKey)switch(String.fromCharCode(event.which).toLowerCase()){case"s":event.preventDefault(),$scope.save()}}),angular.element($window).bind("resize",$scope.calculateBounds),$scope.language=localStorageService.get("lang")||"en_US",$scope.changeLanguage($scope.language),$scope.calculateBounds(),$rootScope.cart=storyCart;var downloadCartModal=$modal({scope:$rootScope,controller:function($rootScope){$rootScope.downloadUrl="",$rootScope.setUrl=function(){if($rootScope.cart.selectedItems.length)if(1===$rootScope.cart.selectedItems.length)$rootScope.downloadUrl="/api/story/"+$rootScope.cart.selectedItems[0].id+"/download";else{var selectedIds=$rootScope.cart.selectedItems.map(function(item){return item.id});$rootScope.downloadUrl="/api/story/"+selectedIds.join(",")+"/download/many"}else $rootScope.downloadUrl=""},$rootScope.setUrl()},template:RUNTIME["static"]+"templates/partials/modals/download-cart.html",id:"download-cart-modal",show:!1});$rootScope.openDownloadCartModal=function(){downloadCartModal.$promise.then(function(){downloadCartModal.show()})}}),angular.module("miller").controller("DraftCtrl",function($scope,$log,$state,localStorageService,StoryFactory,EVENTS){$log.debug("DraftCtrl welcome"),$scope.isSaving=!1,$scope.save=function(){if($log.log("DraftCtrl -> save()"),$scope.isSaving)return void $log.warn(" .. is still saving, be patient.");$scope.isSaving=!0;var metadata={title:{}};metadata.title[$scope.language]=$scope.title,StoryFactory.save({},{title:$scope.title,contents:"",data:metadata,status:"draft"},function(res){$scope.isSaving=!1,$scope.$emit(EVENTS.MESSAGE,"saved"),$log.log("DraftCtrl -> @EVENTS.SAVE saved:",res),$state.go("writing",{storyId:res.slug})},function(err){$log.error(err),$scope.isSaving=!1})},$scope.$on(EVENTS.SAVE,function(){$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.save()})}),angular.module("miller").controller("ItemsCtrl",function($scope,$log,$filter,$state,initials,items,model,factory,description,QueryParamsService,extendItem,EVENTS){function normalizeItems(items){var md=new window.markdownit({breaks:!0,linkify:!0,html:!1}).disable(["image","heading"]);return items.map(function(d){return d.data&&d.data["abstract"]?(d=extendItem(d,$scope.model,{language:$scope.language}),_tag||"publications.tags"!=$state.current.name||(_tag=!0,$scope.setTag(_.find(d.tags,{slug:$state.params.slug}))),d.data["abstract"][$scope.language]?(d.excerpt=md.renderInline($filter("tokenize")(d.data["abstract"][$scope.language],32)),d):d):d})}$log.log("🌻 ItemsCtrl ready, n.:",items.count,"- items:",items,"initials:",initials),$scope.model=model.split(".").shift(),$scope.itemTemplate=model,$scope.nextParams={};var _tag;description&&$state.$current.params&&($scope.topDescription=description.contents),"publications.tags"==$state.current.name?initials.filters.tags__slug__all=[$state.params.slug]:initials.filters&&delete initials.filters.tags__slug__all,"search.story"==$state.current.name&&$scope.setCount(items.count),"publications.tags"!=$state.current.name&&"function"==typeof $scope.setTag&&$scope.setTag(null),$scope.sync=function(res){$scope.isLoadingNextItems=!1,$scope.nextParams=QueryParamsService(res.next||""),$log.log("🌻 ItemsCtrl > sync() next:",$scope.nextParams),$scope.count=res.count,$scope.items=($scope.items||[]).concat(normalizeItems(res.results)),$scope.missing=res.count-$scope.items.length,$scope.showDescription="/"===window.location.pathname&&""===window.location.search},$scope.more=function(){return $scope.isLoadingNextItems?void $log.warn("🌻 is still loading"):($scope.isLoadingNextItems=!0,void factory($scope.nextParams,$scope.sync))},$scope.sync(items),$scope.$on(EVENTS.PARAMS_CHANGED,function(e,newParams){if($scope.isLoadingNextItems)return void $log.warn("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED wait, is still loading");$log.log("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED - params:",newParams),$scope.isLoadingNextItems=!0,$scope.items=[];var params=angular.copy(initials);for(var key in newParams)if("filters"==key)try{params.filters=JSON.stringify(angular.merge(params.filters,JSON.parse(newParams.filters)))}catch(e){$log.warn("🌻 ItemsCtrl @EVENTS.PARAMS_CHANGED wrong filters provided!"),params.filters=initials.filters}else params[key]=newParams[key];factory(params,$scope.sync)}),$scope.boxChecked=function(item){$scope.cart.isItemSelected(item.id)?$scope.cart.deselectItem(item):$scope.cart.selectItem(item)}}),angular.module("miller").controller("LoginCtrl",function($scope,$log,AuthFactory,$location){$log.log("👉 LoginCtrl ready"),$scope.login=function(){$log.debug("👉 LoginCtrl > login"),$scope.pwd&&$scope.pwd.length&&$scope.username&&$scope.username&&AuthFactory.login({username:$scope.username,password:$scope.pwd},function(res){$location.url("/")},function(err){$log.error("👉 LoginCtrl > login error:",err.data)})}}),angular.module("miller").controller("NotificationsCtrl",function($scope,$log,RUNTIME){$log.log("⏱ NotificationsCtrl ready")}),angular.module("miller").controller("PageCtrl",function($scope,$log,page){$log.log("PageCtrl ready",page.status),$scope.md=page.contents,$scope.setOG()}),angular.module("miller").controller("ProfileCtrl",function($scope,$log,profile,authors){$log.log("ProfileCtrl ready, profile:",profile,authors),$scope.profile=profile,$scope.authors=authors.results}),angular.module("miller").controller("PublicationsCtrl",function($scope,$filter,$log,$state,$timeout,$q,AuthorFactory,TagFactory,RUNTIME,EVENTS){$log.log("🔭 PublicationsCtrl welcome"),$scope.rootStatename="publications",$scope.mainStatename="publications.all",$scope.mainRoutes=$scope.user.is_staff?RUNTIME.routes.publications.status:[],$scope.getTranslation=function(translationId){return $filter("translate")(translationId)};var availableRoutes=RUNTIME.routes.publications.availableRoutes||["writing","tags"];$scope.availableRoutes=availableRoutes.map(function(d){var sortBasics=function(arr){return"writing"===d||"tags"===d?arr.sort(function(a,b){return a.slug>b.slug?1:-1}):arr};return{state:"publications",urls:sortBasics(RUNTIME.routes.publications[d])}}),$scope.setTag=function(tag){tag&&$log.log("🔭 PublicationsCtrl -> setTag - slug:",tag.slug,"- name:",tag.name),$scope.tag=tag};var HallOfFames=[];$scope.hallOfFame={},$scope.sync=function(){var ordering,initials=$state.current.resolve.initials(),filters={},exclude={};if($scope.availabileOrderby=initials.availabileOrderby,ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label"),!ordering&&initials.orderby&&(ordering=_.get(_.find($scope.availabileOrderby,{value:initials.orderby}),"label")),ordering||(ordering="newest"),$scope.ordering=ordering,initials.filters){"publications.tags"==$scope.state&&(initials.filters.tags__slug__all=[$state.params.slug]);try{filters=angular.extend({},initials.filters,$scope.filters)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}}if(initials.exclude)try{exclude=JSON.parse(initials.exclude)}catch(e){$log.warn("🔭 PublicationsCtrl sync() cannot parse filters correctly")}$log.log("🔭 PublicationsCtrl sync()",$scope.state),RUNTIME.monographies.indexOf($scope.state)!==-1?HallOfFames.push(TagFactory.hallOfFame({tag__filters:JSON.stringify({category:"publishing"}),orderby:"slug",filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:100},function(res){$scope.hallOfFame.publishings={count:res.count,results:res.results}},function(){}).$spromise):delete $scope.hallOfFame.publishings,HallOfFames.push(AuthorFactory.hallOfFame({filters:JSON.stringify(filters),exclude:JSON.stringify(exclude),limit:10},function(res){$scope.hallOfFame.topAuthors={count:res.count,results:res.results}}).promise),$q.all(HallOfFames,function(){$log.log("🔭 PublicationsCtrl sync() $q.all() finished",$scope.state)})},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("🔭 PublicationsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("PulseCtrl",function($scope,$rootScope,$log,PulseFactory,RUNTIME,EVENTS){if($log.log("⚡ PulseCtrl ready"),$scope.pulsationsCount=0,$scope.pulsations=[],!RUNTIME.settings.wshost)return void $log.warn("⚡ PulseCtrl disabled, no wshost received; please check your miller settings.");var socket=window.socket=new ReconnectingWebSocket(RUNTIME.settings.wshost+"?session_key="+RUNTIME.settings.session_key);socket.onmessage=function(e){$log.log("⚡ PulseCtrl @onmessage raw data:",e.data);var d=e.data;if("object"!=typeof e.data)try{d=JSON.parse(e.data)}catch(err){return void $log.log("⚡ PulseCtrl @onmessage: unable to json parse data: ",e.data,"- error received:",err)}switch($scope.user&&d.actor&&d.actor.username!=$scope.user.username&&$scope.pulsationsCount++,d.verb){case"commented":$rootScope.$emit(EVENTS.SOCKET_USER_COMMENTED_STORY,d),$scope.pulsations.unshift(d);break;case"uncommented":$rootScope.$emit(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,d)}$scope.$apply()},socket.onopen=function(){$log.log("⚡ PulseCtrl online"),$scope.user.username&&PulseFactory.unread({},function(res){$scope.pulsationsCount=res.count})},socket.onclose=function(e){$log.warn("⚡ PulseCtrl socket closed.",e)},socket.onerror=function(e){$log.error("⚡ PulseCtrl socket error",e)},socket.readyState==WebSocket.OPEN&&socket.onopen(),$scope.resetPulsations=function(){return $scope.isLoading?void $log.warn("⚡ PulseCtrl > resetPulsations() still loading..."):($log.log("⚡ PulseCtrl > resetPulsations()"),$scope.isLoading=!0,void PulseFactory.reset({},function(res){$scope.pulsationsCount=0,$scope.isLoading=!1,$scope.pulsations=[]},function(err){$log.warn("⚡ PulseCtrl > loadPulsations() failed!",err),$scope.isLoading=!1}))},$scope.loadPulsations=function(){return $scope.isLoading?void $log.warn("⚡ PulseCtrl > loadPulsations() still loading..."):($log.log("⚡ PulseCtrl > loadPulsations()"),$scope.isLoading=!0,void PulseFactory.noise({},function(res){$scope.pulsations=res.results,$scope.isLoading=!1,$log.log("⚡ PulseCtrl > loadPulsations() success!")},function(err){$log.warn("⚡ PulseCtrl > loadPulsations() failed!",err)}))},$scope.rangyHighlight=function(highlight){$log.log("⚡ PulseCtrl > rangyHighlight()"),$rootScope.$emit(EVENTS.RANGY_FOCUS,highlight)}}),angular.module("miller").controller("ReviewCtrl",function($scope,$rootScope,$log,$state,review,ReviewFactory,RUNTIME,EVENTS){$log.log("⏱ ReviewCtrl ready"),$scope.fields=["thematic","interest","originality","innovation","interdisciplinarity","methodology","clarity","argumentation","structure","references","pertinence"],$scope.availableStatuses=["draft","approved","refusal","bounce"],$scope.reviewStatus=""+review.status,$scope.is_assignee=review.assignee.username==$scope.user.username,$scope.is_reviewed=["complete","refusal","bounce"].indexOf(review.status)!==-1,$scope.is_editable=$scope.is_assignee&&("draft"==review.status||"initial"==review.status),$scope.save=function(){if($log.debug("⏱ ReviewCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0,answers={};for(s in $scope.fields){var field=$scope.fields[s];answers[field]=$scope.review[field],answers[field+"_score"]=$scope.review[field+"_score"]||0}answers.contents=$scope.review.contents,answers.status="draft",ReviewFactory.patch({id:review.id},answers,function(review){$scope.review=review,$log.debug("⏱ ReviewCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"error!"),$scope.unlock(),$scope.isSaving=!1})},$scope.finalize=function(status){if($log.debug("⏱ ReviewCtrl -> finalize() status:",status),$scope.$emit(EVENTS.MESSAGE,"closing the review"),$scope.is_editable=!1,$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0;var answers={};for(s in $scope.fields){var field=$scope.fields[s];answers[field]=$scope.review[field],answers[field+"_score"]=$scope.review[field+"_score"]||0}answers.contents=$scope.review.contents,answers.status=status,ReviewFactory.patch({id:review.id},answers,function(res){$log.debug("⏱ ReviewCtrl -> finalize(): success",res),$scope.unlock(),$scope.isSaving=!1,$state.go("report",{id:review.id})},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"Your request cannot be resolved. Is the review submitted already?"),$scope.unlock(),$scope.isSaving=!1})};var autosave=_.debounce(function(){$scope.save()},5e3,{leading:!0}),__first=!0;$scope.$watch("review",function(r,p){if(r){var filledIn=_.filter(r,function(d,k){return k.indexOf("_score")!=-1});$scope.points=filledIn.reduce(function(a,b){return a+b}),$scope.is_valid=_.compact(filledIn).length==$scope.fields.length&&(r.contents||"").trim().length>0,$log.log("⏱ ReviewCtrl @review - points:",$scope.points,"- can be submitted:",$scope.is_valid,"- filled in fields:",_.compact(filledIn).length),!__first&&$scope.is_editable&&autosave(),__first=!1}},!0),$scope.review=review,$scope.$on(EVENTS.SAVE,$scope.save)}),angular.module("miller").controller("ReviewsCtrl",function($scope,$log,RUNTIME,EVENTS){$log.log("⏱ ReviewsCtrl ready"),$scope.mainStatename="reviews.all",$scope.availableRoutes=[{state:"reviews",urls:RUNTIME.routes.reviews}],$scope.availabileOrderby=[{label:"newest",value:"-date_last_modified"},{label:"oldest",value:"date_last_modified"},{label:"statusaz",value:"status"},{label:"statusza",value:"-status"},{label:"typeaz",value:"category"},{label:"typeza",value:"-category"}],$scope.sync=function(){$scope.ordering=_.get(_.find($scope.availabileOrderby,{value:$scope.qs.orderby}),"label")||"newest"},$scope.sync(),$scope.$on(EVENTS.PARAMS_CHANGED,function(){$log.log("⏱ ReviewsCtrl @EVENTS.PARAMS_CHANGED"),$scope.sync()})}),angular.module("miller").controller("SearchCtrl",function($scope,$log,$stateParams,$location,StoryFactory){
console.log("SearchCtrl welcome",$stateParams.query),$scope.setCount=function(count){$scope.count=count}}),angular.module("miller").controller("SignupCtrl",function($scope,$log){$log.debug("SignupCtrl welcome")}),angular.module("miller").controller("StoryCtrl",function($rootScope,$scope,$log,$filter,$timeout,$modal,story,StoryFactory,StoryGitFactory,CommentFactory,QueryParamsService,extendStoryItem,EVENTS,RUNTIME){story=extendStoryItem(story,$scope.language),$scope.story=story,$scope.story.isWritable=$scope.hasWritingPermission($scope.user,$scope.story),$scope.story.isReviewable=_.get($scope,"review.assignee.username")==$scope.user.username,$scope.story.isUnderReview=["review","editing","pending"].indexOf(story.status)!==-1,$scope.layout="inline",$scope.isLoading=!1,$scope.setOG({title:story.data.title[$scope.language]||story.title,description:story.data["abstract"][$scope.language]||story["abstract"],image:_(story.covers).map(function(d){return _.get(d,"snapshot")||_.get(d,"metadata.thumbnail_url")||_.get(d,"metadata.urls.Publishable")||_.get(d,"metadata.urls.Preview")||_.get(d,"metadata.url")}).first()}),$scope.setStatus=function(status){return $scope.user.is_staff||"public"!=status?($log.debug("StoryCtrl -> setStatus - status:",status),$scope.$emit(EVENTS.MESSAGE,"saving"),void StoryFactory.update({id:$scope.story.id},{title:$scope.story.title,status:status},function(res){console.log("StoryCtrl -> setStatus - new status:",res),$scope.story.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()})):void $log.warn("StoryCtrl -> setStatus failed:",status)},$scope.publish=function(){if($scope.isLoading)return void $log.warn("StoryCtrl > publish() is busy...");$modal({controller:function($scope){$scope.language=$scope.$parent.language,$scope.title="confirm.publish.title",$scope.question="confirm.publish.question",$scope.confirm=function(){$scope.isLoading=!0,StoryFactory.publish({id:$scope.story.id},{},function(res){$scope.story.status=res.status,$scope.story.isUnderReview=["review","editing","pending"].indexOf(res.status)!==-1,$scope.$hide()},$scope.unlock)},$scope.dismiss=function(){$scope.setStatus("draft")}},placement:"confirm",templateUrl:RUNTIME["static"]+"templates/partials/modals/confirm.html",show:!0,scope:$scope})},$scope.comments=[],$scope.commentsCount=0,$scope.isLoadingComments=!1,$scope.commentsNextParams={},$scope.loadComments=function(){return $scope.isLoadingComments?void $log.warn("StoryCtrl > loadComments() is busy loading...!"):($scope.isLoadingComments=!0,$log.log("StoryCtrl > loadComments() loading..."),void StoryFactory.getComments(angular.extend({id:story.id,filters:JSON.stringify({version:story.version}),orderby:"-date_created"},$scope.commentsNextParams),function(res){$scope.comments=($scope.comments||[]).concat(res.results),$scope.commentsCount=res.count,$scope.commentsNextParams=QueryParamsService(res.next||""),$scope.isLoadingComments=!1,$log.log("StoryCtrl > loadComments() loaded. Next:",$scope.commentsNextParams)},function(e){$scope.isLoadingComments=!1,$log.error(e)}))},$scope.moreComments=function(){$scope.loadComments()},$scope.commented=function(error,comment){$log.log("StoryCtrl > commented() deprecaed")},$scope.removeComment=function(comment){return comment.disappear=!0,$scope.isLoadingComments?void $log.warn("StoryCtrl > removeComment() is busy loading...!"):($log.log("StoryCtrl > removeComment() comment:",comment.short_url),$scope.isLoadingComments=!0,void CommentFactory["delete"]({id:comment.short_url},function(res){$scope.isLoadingComments=!1,$log.log("StoryCtrl > removeComment() success!",comment.short_url)},function(){$scope.isLoadingComments=!1}))},$scope.loadNeighbors=function(){StoryFactory.getNeighbors({id:story.id},function(res){$scope.neighbors=res})},$timeout($scope.loadNeighbors(),2e3),$scope.versions=[],$scope.isLoadingVersions=!1,$scope.loadVersions=function(){$scope.isLoadingVersions=!0,StoryGitFactory.getByGitTag({id:story.id},function(res){console.log(res),$scope.isLoadingVersions=!1,$scope.versions=res.results},function(err){console.error(err),$scope.isLoadingVersions=!1})},$scope.createReview=function(){$scope.setStatus("review")},$scope.download=function(){StoryFactory.download({id:$scope.story.id}).$promise.then(function(result){var url=URL.createObjectURL(new Blob([result.data])),a=document.createElement("a");a.href=url,a.download=result.filename,a.target="_blank",a.click()})["catch"](function(error){console.log(error)})},$scope.listener=function(event,data,callback){switch($log.log("StoryCtrl > listener, event:",event,data),event){case EVENTS.MARKDOWNIT_FOCUS:$scope.focusedIdx=data.idx;break;case EVENTS.MARKDOWNIT_FULLSIZE:$rootScope.fullsize(data.slug.replace(/\//g,"-"),data.type);break;case EVENTS.MARKDOWNIT_RESOLVE:$rootScope.resolve(data.slug.replace(/\//g,"-"),data.type,callback)}},$log.log("StoryCtrl ready, title:",story.title,"isWritable:",$scope.story.isWritable),$scope.setDocuments=function(items){$log.log("StoryCtrl > setDocuments items n.:",items.length,items);var documents=[];$scope.sidedocuments=0,documents=_(items).map(function(d){for(var i=0;i<story.documents.length;i++)if(story.documents[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.documents[i]);for(i=0;i<story.stories.length;i++)if(story.stories[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.stories[i]);return $scope.sidedocuments++,d}).value(),$log.log("StoryCtrl > setDocuments items n.:",items.length,"- documents n:",documents.length,"- sideDocuments:",$scope.sidedocuments),$scope.$parent.setDocuments(documents)},$scope.commentsSelected=function(uids){$log.log("StoryCtrl > commentsSelected uids:",uids)},$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,_.debounce(function(e,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_COMMENTED_STORY, update the comment list!"),data.info.comment.highlights&&$scope.story.highlights.push(data.info.comment.highlights),data.info.comment.unread=!0,$scope.comments.unshift(data.info.comment),$scope.commentsCount++,$scope.commentsNextParams.offset&&$scope.commentsNextParams.offset++,$scope.$apply())},200)),$rootScope.$on(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,function(event,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_UNCOMMENTED_STORY, update the comment list!",$scope.comments),$scope.commentsCount--,$scope.comments=_.filter($scope.comments,function(d){return d.short_url!=data.info.comment.short_url}),data.info.comment.highlights&&data.info.comment.highlights.length&&($scope.story.highlights=_.filter($scope.story.highlights,function(d){return d!=data.info.comment.highlights})),$scope.$apply())})}),angular.module("miller").controller("UploadCtrl",function($scope,$state,$log,Upload,EVENTS){$log.debug("UploadCtrl welcome"),$scope.uploadable={title:"","abstract":""},$scope.$watch("docx",function(v){v&&($log.debug("UploadCtrl @docx",v.name,v.size),$scope.uploadable.docx=v,$scope.uploadable.name=v.name,$scope.uploadable.size=v.size)}),$scope.upload=function(){return $log.debug("UploadCtrl -> upload()"),$scope.createForm.$valid?!$scope.uploadable.docx||$scope.uploadable.docx.$error?void $log.warn("UploadCtrl -> upload() cannot find a valid docx file"):void Upload.upload({url:"/api/story/",data:{title:$scope.uploadable.title,"abstract":$scope.uploadable["abstract"],source:$scope.uploadable.docx}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status&&($log.debug("UploadCtrl -> upload() status:","success!",res.data),$state.go("story",{postId:res.data.slug}))},null,function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$log.log("progress: "+progressPercentage+"% "+evt.config.data.source.name)}):void $log.warn("UploadCtrl -> upload() errors:",$scope.createForm.$error)}}),angular.module("miller").controller("UploadedCtrl",function($scope,$log,story){$log.debug("UploadedCtrl welcome",story),$scope.story=story}),angular.module("miller").controller("WritingCtrl",function($rootScope,$scope,$http,$log,$q,$state,$modal,$filter,$timeout,story,StoryGitFactory,localStorageService,extendStoryItem,StoryFactory,StoryTagsFactory,StoryDocumentsFactory,CaptionFactory,MentionFactory,DocumentFactory,AuthorFactory,TagFactory,EVENTS,RUNTIME){$log.debug("WritingCtrl writing title:",story.title,"-id:",story.id,"- current language:",$scope.language),$scope.state=$state,story=extendStoryItem(story,$scope.language),$scope.story=story,$scope.isSaving=!1,["title","abstract"].forEach(function(field){$scope.language&&!$scope.story.data[field][$scope.language]&&($scope.story.data[field][$scope.language]=story[field])}),$scope.id=story.id,$scope.title=$scope.story.data.title[$scope.language],$scope["abstract"]=$scope.story.data["abstract"][$scope.language],$scope.storyOnMap=!!story.longitude||!!story.latitude,$scope.longitude=story.longitude,$scope.latitude=story.latitude,$scope.removeFromMap=function(){$scope.storyOnMap=!1,$scope.longitude=null,$scope.latitude=null},$scope.address="",$scope.addressSearchOpened=!1,$scope.openAddressSearch=function(){$scope.addressSearchOpened=!0},$scope.searchAddress=function(){""!==$scope.address&&$http.get("https://nominatim.openstreetmap.org/search",{params:{q:this.address,limit:1,format:"json"}}).then(function(res){if(0===res.data.length)return void $scope.$emit(EVENTS.ERROR,"Address not found");var data=res.data[0];$scope.latitude=data.lat,$scope.longitude=data.lon,$scope.address="",$scope.$emit(EVENTS.MESSAGE,"Coordinates updated")},function(err){$scope.$emit(EVENTS.ERROR,"Unable to search the address")})},""===story.contents&&(story.contents="We propose the following headlines for your article:\n## Description\n## Goals\n## Target audience\n## Challenges\n## Contact\n## Partners\n## Similar actions\n## Legal basis\n## Available resources\n## Impact"),$scope.contents=story.contents,$scope.clearContent=function(){$scope.contents=""},$scope.tagFields=RUNTIME.writings.tags;for(var i=0,j=$scope.tagFields.length;i<j;i++)$scope.tagFields[i].tags=_.filter(story.tags,$scope.tagFields[i].lambda);$scope.metadata={status:story.status,owner:story.owner},$scope.setStatus=function(status){$scope.metadata.status=status,$scope.save()};var initialItems={doc:_.map(story.documents,"slug"),voc:_.map(story.stories,"slug")};$scope.sideItems=[],$scope.setDocuments=function(items){$log.log("WritingCtrl -> setDocuments()",items.length);for(var tobesaved={doc:[],voc:[]},tobedeleted={doc:[],voc:[]},tobekept={doc:[],voc:[]},i=0;i<items.length;i++){var t="block-doc"==items[i]._type?"doc":items[i]._type;initialItems[t]&&(initialItems[t].indexOf(items[i].slug)===-1?tobesaved[t].push(items[i].slug):tobekept[t].push(items[i].slug))}tobedeleted.doc=_.difference(initialItems.doc,tobekept.doc,tobesaved.doc),tobedeleted.voc=_.difference(initialItems.voc,tobekept.voc,tobesaved.voc),$log.log("... tobesaved:",tobesaved),$log.log("... tobedeleted:",tobedeleted),$log.log("... tobekept:",tobekept),$q.all(_.compact(_.uniq(tobesaved.doc).map(function(slug){var p=CaptionFactory.save({story:story.id,document:slug},function(res){$log.warn("... CaptionFactory.save success",res)},function(err){$log.warn("... CaptionFactory.save failed",err)}).promise;return p}).concat(_.uniq(tobesaved.voc).map(function(slug){$log.log("... saving voc->story slug:",slug);var p=MentionFactory.save({from_story:story.id,to_story:{slug:slug}},function(res){$log.log("... saving voc->story success",res)},function(err){$log.warn("... saving voc->story success failed miserably: ",err)}).promise;return p})).concat(_.uniq(tobedeleted.doc).map(function(slug){$log.log("... deleting doc->story slug:",slug)})).concat(_.uniq(tobedeleted.voc).map(function(slug){$log.log("... deleting voc->story slug:",slug)})))).then(function(results){$log.log("... setDocuments() done. Results:",results),results.length&&$scope.save(),$scope.sideItems=items})};var refresh;$scope.setMarked=function(marked){$log.log("WritingCtrl > setMarked()"),$scope.marked=marked,refresh&&$timeout.cancel(refresh),refresh=$timeout(function(){$rootScope.$emit(EVENTS.RANGY_REFRESH)},1e3)},$scope.setCover=function(doc){$log.debug("WritingCtrl -> setCover() doc:",doc.id),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{covers:$scope.biography?[$scope.biography.id,doc.id]:[doc.id]}).$promise.then(function(res){$log.debug("WritingCtrl -> setCover() doc success",res),$scope.story.covers=[doc],$scope.unlock(),$scope.isSaving=!1})},$scope.detachAuthor=function(target){target.profile.user&&target.profile.user.id===$scope.story.owner.id?$scope.story.authors.unshift(target):$scope.story.authors.length<1&&target&&($scope.story.authors.push(target),alert("At least one author is needed"))},$scope.removeCover=function(doc){return $log.debug("WritingCtrl -> removeCover() doc:",doc.id),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,$scope.lock(),void StoryFactory.patch({id:story.id},{covers:$scope.biography?[$scope.biography.id]:[]}).$promise.then(function(res){$log.debug("WritingCtrl -> removeCover() doc success",res),$scope.story.covers=[],$scope.unlock(),$scope.isSaving=!1},function(err){$log.error("WritingCtrl -> removeCover() doc error",err),$scope.unlock(),$scope.isSaving=!1}))},$scope.references=[],$scope.lookups=[],$scope.attachTag=function(tag){return $log.debug("WritingCtrl -> attachTag() tag",arguments),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):tag.id?($scope.isSaving=!0,$scope.lock(),$scope.story.data._ordering.tags[tag.category]||($scope.story.data._ordering.tags[tag.category]=[]),$scope.story.data._ordering.tags[tag.category].push(tag.id),StoryFactory.patch({id:story.id},{tags:_($scope.tagFields).map("tags").flatten().map("id").concat([tag.id]).uniq().value(),data:$scope.story.data}).$promise.then(function(res){return $log.debug("WritingCtrl -> attachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return $scope.unlock(),$scope.isSaving=!1,!1})):void $log.error("wait, there is no tag.id...",tag)},$scope.setToC=function(){},$scope.beforeAttachTag=function(tag,el){return $log.log("WritingCtrl -> beforeAttachTag() tag",tag),"__new__"==tag.type?($scope.openAddTagModal(tag.query),!1):$scope.attachTag(tag)},$scope.detachTag=function(tag){return $log.debug("WritingCtrl -> detachTag() tag",arguments,$scope.displayedTags),$scope.isSaving=!0,$scope.lock(),$scope.story.data._ordering.tags[tag.category]=_($scope.tagFields).map("tags").flatten().filter({category:tag.category}).map("id").value(),StoryFactory.patch({id:story.id},{tags:_($scope.tagFields).map("tags").flatten().map("id").uniq().value(),data:$scope.story.data}).$promise.then(function(res){return $log.debug("WritingCtrl -> detachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})};var addTagModal=$modal({scope:$scope,controller:function($scope,TagFactory){$log.log("addTagModalCtrl is ready. Initial value:",$scope.keywordToAttach),$scope.name=$scope.keywordToAttach||"",$scope.data={provider:"",creator:$scope.user.username,name:{}},$scope.conflicts={},$scope.update=function(){TagFactory.update({id:$scope.tag.id},{name:$scope.name,category:"keyword",data:$scope.data},function(tag){$log.debug("addTagModalCtrl -> update() tag updated."),$scope.$parent.attachTag(tag),$scope.$hide()})},$scope.confirm=function(){$log.debug("addTagModalCtrl -> confirm() saving tag..."),TagFactory.save({name:$scope.name,category:"keyword",data:$scope.data},function(tag){if(tag.created)$log.debug("addTagModalCtrl -> confirm() tag created!"),$scope.attachTag(tag),$scope.$hide();else{$log.debug("addTagModalCtrl -> confirm() tag exists. Update before use."),$scope.tag=tag;for(var i in $scope.settings.languages)_key=$scope.settings.languages[i],$scope.data.name[_key]&&$scope.data.name[_key]!=$scope.tag.data.name[_key]&&($scope.conflicts[_key]=$scope.tag.data.name[_key]),$scope.data.name[_key]=$scope.data.name[_key]||$scope.tag.data.name[_key]}},function(){})}},template:RUNTIME["static"]+"templates/partials/modals/add-tag.html",id:"writing.addtag",show:!1});$scope.openAddTagModal=function(value){$scope.keywordToAttach=value,addTagModal.$promise.then(function(){$log.log("WritingCtrl -> openAddTagModal()"),addTagModal.show()})};var saveDoiModal=$modal({template:RUNTIME["static"]+"templates/partials/modals/save-doi.html",id:"writing.savedoi",controller:"SaveDoiModalCtrl",scope:$scope,resolve:{storyId:function(){return story.id}},show:!1});$scope.openSaveDoiModal=function(value){saveDoiModal.$promise.then(function(){$log.log("WritingCtrl -> openSaveDoiModal()"),saveDoiModal.show()})},$scope.localUpdateDoi=function(doi){$scope.story.data.doi=doi};var saveVersionModal=$modal({template:RUNTIME["static"]+"templates/partials/modals/save-version.html",id:"writing.saveversion",controller:function($scope,$log,StoryGitFactory){$scope.version={tag:"",message:""},$scope.is_saving=!1,$scope.confirm=function(){$scope.is_saving=!0,StoryGitFactory.saveVersion({id:story.id},{tag:$scope.version.tag.trim(),message:$scope.version.message.trim()},function(res){$log.debug(res),$scope.is_saving=!1,$scope.$hide()},function(err){$log.error(err),err.data&&($scope.errors=err.data),$scope.is_saving=!1})}},show:!1});$scope.openSaveVersionModal=function(value){$scope.save(function(){saveVersionModal.$promise.then(function(){$log.log("WritingCtrl -> openSaveVersionModal()"),saveVersionModal.show()})})},$scope.suggestAuthors=function(query,options){$log.log("WritingCtrl -> suggestAuthors",query,options);var filters=angular.extend(options||{},{fullname__icontains:query});return console.log(filters),$log.log("FILTERS:",filters),AuthorFactory.get({filters:JSON.stringify(filters),exclude:JSON.stringify({id__in:_.map($scope.story.authors,"id")})}).$promise.then(function(response){return response.results})},$scope.suggestReferences=function(service){service||DocumentFactory.get(function(){console.log("list")})};var coversModal=$modal({controller:"CoversModalCtrl",templateUrl:RUNTIME["static"]+"templates/partials/modals/covers.html",show:!1,scope:$scope});$scope.openCoversModal=function(){coversModal.$promise.then(function(){$log.log("WritingCtrl -> openCoversModal()"),coversModal.show()})},$scope.save=function(next){if($log.debug("WritingCtrl @SAVE"),!validateCoordinates($scope.longitude,$scope.latitude))return void $scope.$emit(EVENTS.ERROR,"Invalid coordinates");if($scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0,$scope.story.data._ordering.authors=_.map($scope.story.authors,"id");var update=angular.extend({title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,data:$scope.story.data,date:$scope.date,authors:_.map($scope.story.authors,"id"),longitude:$scope.longitude,latitude:$scope.latitude},$scope.metadata);StoryFactory.update({id:story.id},update,function(res){$scope.story.version=res.version,$scope.story.logs=res.logs,$log.debug("WritingCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1),"function"==typeof next&&next()},function(){$scope.isSaving=!1})},$scope.versions=[],$scope.isLoadingVersions=!1,$scope.loadVersions=function(){$scope.isLoadingVersions=!0,StoryGitFactory.getByGitTag({id:story.id},function(res){console.log(res),$scope.isLoadingVersions=!1,$scope.versions=res.results},function(err){console.error(err),$scope.isLoadingVersions=!1})},$scope.toolboxing=function(action){$log.debug("WritingCtrl °°toolboxing:",action),$scope.$broadcast("mde.toolbox",{action:action})},$scope.activeStates=[],$scope.$on("mde.activestates",function(e,activestates){$scope.activeStates=activestates}),$scope.$on(EVENTS.SAVE,$scope.save),$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,function(e,data){data.target.id==story.id&&($log.log("StoryCtrl @SOCKET_USER_COMMENTED_STORY, update the comment list!"),data.info.comment.highlights&&$scope.story.highlights.push(data.info.comment.highlights),data.info.comment.unread=!0,$scope.$apply())}),$scope.$on(EVENTS.PARAMS_CHANGED,function(e,qs){qs.collection&&qs.collection.match(/^[a-zA-Z\-\_\d]+$/)&&($scope.collection=qs.collection)}),$scope.$watch("contents",function(v,p){v&&v!=p&&$scope.toggleStopStateChangeStart(!0)}),$scope.$watch("language",function(v,p){v&&v!=p&&(["title","abstract"].forEach(function(d){$scope[d]=$scope.story.metadata[d][v]||$scope[d]}),$log.log("WritingCtrl @language"))}),$scope.$watch("title",function(v){$scope.language&&($scope.story.data.title[$scope.language]=v)}),$scope.$watch("abstract",function(v){$scope.language&&($scope.story.data["abstract"][$scope.language]=v)})}),angular.module("miller").controller("AddReviewModalCtrl",function($scope,$log,$q,story,ReviewFactory){$log.info("AddReviewModalCtrl ready with crazy scope",arguments),$scope.reviewers=[],$scope.confirm=function(){return $scope.reviewers.length?($log.info("AddReviewModalCtrl -> confirm()"),void $q.all(_($scope.reviewers).map(function(assignee){var p=ReviewFactory.save({},{assignee:assignee.id,story:story.id,category:"double",contents:""});return p.$promise}).value()).then(function(results){story.reviews=story.reviews.concat(results.map(function(a,i){return a.assignee=$scope.reviewers[i],a})),$scope.$hide()},function(){})):void $log.warn("AddReviewModalCtrl -> confirm() without any reviewers?")},$scope.dismiss=function(){}}),angular.module("miller").controller("CoversModalCtrl",function($scope,$log,QueryParamsService,DocumentFactory,Upload){$log.info("CoversModalCtrl ready with crazy scope, n. covers:",$scope.story.covers.length),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{caption__story__owner__username:$scope.user.username,contents__icontains:query}:{caption__story__owner__username:$scope.user.username})},function(res){$log.debug("CoversModalCtrl - tab.favourite > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.favourite > init"),this.suggest($scope.query||"")}},all:{name:"all",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.all > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.debug("CoversModalCtrl - tab.all > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.all > init"),this.suggest($scope.query||"")}},upload:{name:"upload",items:[],undo:function(){$scope.uploadable=null,$scope.uploadablefile={}},upload:function(){if(!$scope.uploadablefile)return void $log.warn("no file is selected");if(!$scope.uploadablefile.copyright)return $log.warn("no copyright provided"),void alert("Copyright required");if(!$scope.uploadablefile.copyrightConfirmation)return $log.warn("no copyright confirmation provided"),void alert("Copyright checkbox required");var types={"image/jpg":"image","image/png":"image","application/pdf":"pdf"};Upload.upload({url:"/api/document/",data:{title:$scope.uploadablefile.title||$scope.uploadablefile.name,type:types[$scope.uploadablefile.type]||$scope.uploadablefile.type.split("/").shift(),mimetype:$scope.uploadablefile.type,copyrights:$scope.uploadablefile.copyright,metadata:JSON.stringify({bibtex:$scope.reference,copyrights:$scope.uploadablefile.copyright}),attachment:$scope.uploadablefile.f}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status?($log.debug("UploadCtrl -> upload() status:","success!",res.data),$scope.uploadablefile.progressPercentage=0,$scope.uploadablefile.document=res.data,$scope.selectDocument($scope.uploadablefile.document)):$log.error(res)},null,function(evt){$scope.uploadablefile.progressPercentage=parseInt(1e4*evt.loaded/evt.total)/100,$log.log("progress: "+$scope.uploadablefile.progressPercentage+"% "+evt.config.data,$scope.uploadablefile.name,evt)})},init:function(){$log.log("init",this),$scope.uploadable=null,$scope.uploadablefile={}}}},$scope.uploadablefile={},$scope.$watch("uploadable",function(v){v&&($log.debug("::mde @uploadable",v),$scope.uploadablefile.f=v,$scope.uploadablefile.name=v.name,$scope.uploadablefile.size=v.size,$scope.uploadablefile.type=v.type)}),$scope.upload=function(query){$log.log("CoverCtrl -> upload()"),$scope.tab.upload()},$scope.selectDocument=function(doc){$log.debug("CoversModalCtrl -> selectDocument() id:",doc.id),$scope.selectedDocument&&$scope.selectedDocument.id==doc.id?($scope.isSomethingSelected=!1,$scope.selectedDocument=!1):($scope.isSomethingSelected=!0,$scope.selectedDocument=angular.copy(doc))},$scope.addDocument=function(){return $scope.selectedDocument?($log.debug("CoversModalCtrl -> addDocument() id:",$scope.selectedDocument.id),$scope.setCover($scope.selectedDocument),void $scope.$hide()):void $log.warn("CoversModalCtrl -> addDocument() no document has been selected")},$scope.setTab=function(tabname){$log.debug("CoversModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.debug("CoversModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.debug("CoversModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab("favourite")}),angular.module("miller").controller("EnrichModalCtrl",function($timeout,$scope,$log,QueryParamsService,DocumentFactory,StoryFactory,OembedSearchFactory,CrossRefFactory,localStorageService,Upload){$log.info("EnrichModalCtrl ready with crazy scope, language:",$scope.language),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggestions:[],suggest:function(query,keep){var $s=this,q=query&&query.length>2?query.replace("*","").trim()+"*":"";$log.log("tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),DocumentFactory.get($s.next||{q:q,facets:"data__type"},function(res){$log.log("tab.favourite > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1,$s.typeahead(query)})},suggestquery:function(q){var $s=this;$scope.query=q,$s.suggest(q)},typeahead:function(query){var $s=this;return!query||query.length<3?void($s.suggestions=[]):void DocumentFactory.suggest({q:query},function(res){$s.suggestions=res.results})},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},url:{name:"url",items:[],suggest:function(url,keep){},onEmbedChange:function(){$log.log("EMC @embed embed.type:",$scope.embed.type),$scope.embed.html&&"link"==$scope.embed.type&&($scope.embed.type="rich")},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.url||"")}},upload:{name:"upload",items:[],undo:function(){$scope.uploadable=null,$scope.uploadablefile={}},upload:function(){if(!$scope.uploadablefile)return void $log.warn("no file is selected");if(!$scope.uploadablefile.copyright)return $log.warn("no copyright provided"),void alert("Copyright required");if(!$scope.uploadablefile.copyrightConfirmation)return $log.warn("no copyright confirmation provided"),void alert("Copyright checkbox required");var types={"image/jpg":"image","image/png":"image","application/pdf":"pdf"};Upload.upload({url:"/api/document/",data:{title:$scope.uploadablefile.title||$scope.uploadablefile.name,type:types[$scope.uploadablefile.type]||$scope.uploadablefile.type.split("/").shift(),mimetype:$scope.uploadablefile.type,copyrights:$scope.uploadablefile.copyright,metadata:JSON.stringify({bibtex:$scope.reference,copyrights:$scope.uploadablefile.copyright}),attachment:$scope.uploadablefile.f}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status?($log.debug("UploadCtrl -> upload() status:","success!",res.data),$scope.uploadablefile.progressPercentage=0,$scope.uploadablefile.document=res.data,$scope.selectDocument($scope.uploadablefile.document)):$log.error(res)},null,function(evt){$scope.uploadablefile.progressPercentage=parseInt(1e4*evt.loaded/evt.total)/100,$log.log("progress: "+$scope.uploadablefile.progressPercentage+"% "+evt.config.data,$scope.uploadablefile.name,evt)})},init:function(){$log.log("init",this),$scope.uploadable=null,$scope.uploadablefile={},localStorageService.set("lasttabname",this.name)}}},$scope.uploadablefile={},$scope.$watch("uploadable",function(v){v&&($log.debug("::mde @uploadable",v),$scope.uploadablefile.f=v,$scope.uploadablefile.name=v.name,$scope.uploadablefile.size=v.size,$scope.uploadablefile.type=v.type)});var timer_preview;$scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?($scope.isUrlValid=!0,url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),$scope.suggestMessage="(loading...)",DocumentFactory.oembed({url:url},function(data){$log.debug(":: mde -> previewUrl() received:",data),$scope.embed=data,$scope.suggestMessage="(<b>done</b>)"},function(err){$scope.suggestMessage="(<b>error</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),$scope.suggestMessage="(url is not valid)",$scope.isUrlValid=!1,$scope.embed=null,!1)},$scope.setTab=function(tabname){$log.log("EnrichModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.log("EnrichModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.upload=function(query){$log.log("EnrichModalCtrl -> upload()"),console.log($scope),$scope.tab.upload()},$scope.undo=function(){$log.log("EnrichModalCtrl -> undo()"),$scope.tab.undo()},$scope.more=function(query,tab){$log.log("EnrichModalCtrl -> more()"),$scope.tab.suggest(query,!0)};var initialTab=localStorageService.get("lasttabname")||"favourite";Object.keys($scope.tabs).findIndex(function(t){return t===initialTab})===-1&&(initialTab="favourite"),$scope.setTab(initialTab)}),angular.module("miller").controller("FinalDecisionModalCtrl",function($scope,$log,$q,story,ReviewFactory){$log.info("FinalDecisionModalCtrl ready with crazy scope",arguments),$scope.reviewers=[],$scope.review={status:!1,contents:""},$scope.availableStatus=["approved","bounce","refusal"],$scope.confirm=function(){return $scope.review.status?($scope.isSaving&&$log.warn("FinalDecisionModalCtrl -> confirm() please wait, is still saving data..."),$scope.isSaving=!0,$log.info("FinalDecisionModalCtrl -> confirm()",$scope.review.status),void ReviewFactory.close({story:story.id,contents:$scope.review.contents,status:$scope.review.status},function(){$scope.isSaving=!1,story.status="reviewdone",$scope.$hide()},function(){$scope.isSaving=!1;
})):void $log.warn("FinalDecisionModalCtrl -> confirm() without any finalStatus?")},$scope.dismiss=function(){}}),angular.module("miller").controller("SaveDoiModalCtrl",function($log,$scope,storyId,StoryDOIMetadataFactory,EVENTS){$scope.storyId=storyId,$scope.loadCurrentMetadata=function(options){return StoryDOIMetadataFactory.getMetadata(angular.extend({},options,{id:storyId}),function(res){$log.log("[GET] SaveDoiModalCtrl -> loadCurrentMetadata() success, doi:",res.DOI,"- with params:",options),$scope.currentMetadata=res,$scope.doi=res.DOI},function(res){$log.warn("[GET] SaveDoiModalCtrl -> loadCurrentMetadata() error, request status:",res.status,"with params:",res)}).$promise},StoryDOIMetadataFactory.get({id:storyId},function(res){$log.log("[GET] SaveDoiModalCtrl -> init remote doi SUCCESS :",{doi:res.doi,url:res.url}),$scope.should_update_doi=!0,$scope.loadCurrentMetadata({test:!0})},function(res){$log.warn("[GET] SaveDoiModalCtrl -> init remote doi FAILED:",res)}).$promise["finally"](function(){$scope.loadCurrentMetadata({test:!0})}),$scope.confirm=function(){$scope.is_saving=!0,StoryDOIMetadataFactory.updateMetadata({id:storyId},{},function(res){$log.log("[POST] SaveDoiModalCtrl updateMetadata() success, doi:",res.DOI),$scope.should_update_doi?($scope.localUpdateDoi($scope.doi),$scope.$hide(),$scope.$emit(EVENTS.MESSAGE,"DOI updated!")):StoryDOIMetadataFactory.save({id:storyId},{},function(res){$log.log("[POST] SaveDoiModalCtrl DOI save() success, doi:",res.DOI,"url:"),$scope.is_saving=!1,$scope.localUpdateDoi($scope.doi),$scope.$hide(),$scope.$emit(EVENTS.MESSAGE,"DOI created!")},function(err){$scope.is_saving=!1})},function(err){$scope.is_saving=!1,$scope.log_message=err.data,$log.warn("SaveDoiModalCtrl loadCurrentMetadata() error, request status:",err.status,"with params:",err)})}}),angular.module("miller").directive("biography",function($log,$rootScope,$window,$timeout,RUNTIME,EVENTS){var FRAME_MARGIN_TOP=15,FRAME_MARGIN=35,LIFESPAN_HEIGHT=90,ACTIVITY_HEIGHT=25,utils={};return utils.calculateBoundaries=function(from,to,offset,ratio){return console.log("♾ biography from:",from,"to:",yearTo,"w:",yearTo-from,"l:",from-biography.mindate),{width:lifespan.ratio*(yearTo-from),left:lifespan.ratio*(from-biography.mindate)}},{restrict:"A",scope:{data:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/biography.html",link:function(scope,element,attrs){var isReady=!1,biography={element:element.find(".biography"),tooltip:element.find(".biography-tooltip"),height:0,width:0,years:{min:0,max:0,delta:0},ratio:0},lifespan={years:{min:1/0,max:-(1/0),delta:0}};leftdate={},rightdate={},scope.tooltip={idx:-1},scope.init=function(){if(!scope.data.activities||!scope.data.activities.length)return void $log.warning("♾ biography init(), no activities data available! Skipping");scope.data.activities=scope.data.activities.sort(function(a,b){return a.start_date>b.start_date?1:a.start_date==b.start_date&&a.end_date>b.end_date?1:-1}),biography.height=Math.max(300,FRAME_MARGIN_TOP+LIFESPAN_HEIGHT+25*scope.data.activities.length),biography.element.height(biography.height),biography.years.max=("string"==typeof scope.data.end_date?new Date(scope.data.end_date):new Date).getFullYear(),biography.years.min=new Date(scope.data.start_date).getFullYear(),biography.years.delta=biography.years.max-biography.years.min;for(var i=0,l=scope.data.activities.length;i<l;i++)scope.data.activities[i].start_date&&(lifespan.years.min=Math.min(scope.data.activities[i].start_date,lifespan.years.min)),scope.data.activities[i].end_date?lifespan.years.max=Math.max(scope.data.activities[i].end_date,lifespan.years.max):scope.data.activities[i].start_date&&(lifespan.years.max=Math.max(scope.data.activities[i].start_date,lifespan.years.max));return lifespan.years.min&&lifespan.years.max?(lifespan.years.delta=lifespan.years.max-lifespan.years.min,$log.log("♾ biography -> init(), biography:",biography,"- lifespan:",lifespan),isReady=!0,void scope.render()):void $log.warning("♾ biography -> init(), error in boundaries")},scope.render=function(){if(isReady){var availableWidth=parseInt(biography.element.width());biography.width!=availableWidth&&(biography.width=availableWidth,biography.ratio=(biography.width-2*FRAME_MARGIN)/biography.years.delta,lifespan.width=biography.ratio*lifespan.years.delta,lifespan.left=biography.ratio*(lifespan.years.min-biography.years.min),lifespan.right=biography.ratio*(biography.years.max-lifespan.years.max),lifespan.ratio=(biography.width-2*FRAME_MARGIN-20)/lifespan.years.delta,$log.log("♾ biography -> render() \n  biography:\n  - width:",biography.width,"\n  - ratio:",biography.ratio,"\n  - delta:",biography.years.delta,"\n\n  lifespan:\n  - width:",lifespan.width,"\n  - ratio:",lifespan.ratio,"\n  - delta:",lifespan.years.delta),scope.data.activities=scope.data.activities.map(function(activity){activity.height=ACTIVITY_HEIGHT,activity.left=lifespan.ratio*(activity.start_date-lifespan.years.min),activity.right=lifespan.ratio*(lifespan.years.max-activity.end_date),activity.end_date||(activity.end_date=activity.start_date,activity.end_date_fuzzy=!0),activity.start_date||(activity.end_date=activity.end_date,activity.start_date_fuzzy=!0),activity.uniqdate=activity.start_date==activity.end_date,activity.nodate=!activity.start_date&&!activity.end_date,$log.log("♾ biography -> render()",activity.start_date,activity.end_date);var _left=activity.left+lifespan.ratio*(activity.end_date-activity.start_date)+10,_right=biography.width-2*FRAME_MARGIN-20-lifespan.ratio*(activity.start_date-lifespan.years.min)+40;return activity.uniqdate||(_left+=29),activity.description.alignment=_left>_right?"left":"right",activity.description.left=_left,activity.description.right=_right,activity}),scope.lifespan=lifespan,scope.biography=biography,$rootScope.$emit(EVENTS.RESIZE))}},scope.showTooltip=function(activity,idx,event,lock){scope.tooltip=activity,scope.tooltip.idx=idx;var left=activity.left,bottom=(scope.data.activities.length-idx)*ACTIVITY_HEIGHT+10;scope.tooltip.left=left,scope.tooltip.bottom=bottom,lock&&(scope.tooltip.locked=!0)},scope.hideTooltip=function(force){scope.tooltip.locked&&!force||scope.tooltip&&(scope.tooltip.idx=-1)},scope.cleanUp=function(){angular.element($window).off("resize",scope.render)},scope.init(),angular.element($window).on("resize",scope.render),scope.$on("$destroy",scope.cleanUp)}}}),angular.module("miller").directive("commenter",function($log,$rootScope,angularLoad,CommentFactory,EVENTS,RUNTIME){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/commenter.html",scope:{target:"=",actor:"=",highlight:"=",commented:"&",discarded:"&",commentsSelected:"="},link:function(scope,element,attrs){scope.cachedCommentsUid=[],scope.cachedComments=[],scope.attachedComments=[],scope.disableClose=attrs.disableClose,scope.disableViewer=attrs.disableViewer,scope.leaveComment=function(comment){if($log.log(":: commenter > leaveComment() called"),scope.isLoading)return void $scope.warn(":: commenter is already doing something");scope.isLoading=!0;var highlights=scope.highlight?scope.highlight.s:"";if(!scope.highlight&&scope.attachedComments.length&&scope.commentSelectedHighlights){var highlightsParts=scope.commentSelectedHighlights.split("$");highlightsParts[3]="highlight",highlights=highlightsParts.join("$")}CommentFactory.save({contents:JSON.stringify({content:scope.content,quote:scope.quote||""}),highlights:highlights,version:scope.target.version,story:scope.target.id},function(res){scope.content="",scope.isLoading=!1,$log.log(":: commenter > leaveComment() success",res),scope.commented({error:null,comment:res})},function(err){err.data&&(scope.errors=err.data),scope.isLoading=!1,$log.error(":: commenter > leaveComment() failed",err),scope.commented({error:err,comment:null})})},scope.discard=function(event){$log.log(":: commenter > discard()"),scope.discarded(),event.stopImmediatePropagation()},scope.$watch("highlight",function(highlight){$log.log(":: commenter @highlight:",highlight),highlight&&highlight.h?scope.quote=highlight.h.getText():scope.quote=null,scope.content=""}),attrs.disableViewer||scope.$watchCollection("commentsSelected",function(uids){uids&&uids.length?CommentFactory.get({filters:JSON.stringify({short_url__in:uids}),limit:Math.max(uids.length,20),orderby:"-date"},function(res){scope.attachedTotalComments=res.count,scope.attachedComments=res.results;var com=_(scope.attachedComments,"contents.quote").map().first();com&&(scope.quote=com.contents.quote,scope.commentSelectedHighlights=com.highlights)}):(scope.attachedTotalComments=0,scope.attachedComments=[])}),$log.log(":: commenter ready")}}}).directive("commenterQuote",function(){return{restrict:"A",scope:{quote:"=commenterQuote"},link:function(scope,element,attrs){scope.$watch("quote",function(text){if(text){var words=text.trim().split(/\s+/),max_words=attrs.maxWords||3;element.html(words.length>2*max_words?_.take(words,max_words).concat(["[...]"],_.takeRight(words,max_words)).join(" "):text)}})}}}),angular.module("miller").directive("rewording",function($rootScope,EVENTS){return{restrict:"A",scope:{value:"=",follow:"=",highlight:"&?"},template:'<span ng-bind-html="renderedValue"></span>',link:function(scope,element,attrs){scope.render=function(event,language){if(language){var _renderedValue=attrs["default"];if("object"==typeof scope.value&&(_renderedValue=_.get(scope.value,language),_renderedValue||(_renderedValue=_(scope.value).filter().first())),attrs.markdown){var md=new window.markdownit({breaks:!0,linkify:!0,html:!1}).disable(["image","heading"]);_renderedValue=_renderedValue||"",_renderedValue="inline"==attrs.markdown?md.renderInline(_renderedValue):md.render(_renderedValue)}scope.highlight?scope.renderedValue=scope.highlight({text:_renderedValue}):scope.renderedValue=_renderedValue||attrs["default"]}},scope.$on(EVENTS.LANGUAGE_CHANGED,scope.render),attrs.follow?scope.$watch("follow",function(v){"true"===attrs.debug&&console.log("::: embedit @follow - value:",v),v&&scope.render(null,$rootScope.language)}):scope.render(null,$rootScope.language)}}}).directive("embedit",function($sce,$timeout,$filter){return{restrict:"A",scope:{embedit:"=",stretch:"=",language:"=",firstline:"="},link:function(scope,element,attrs){var stretching,options={breaks:!0,linkify:!0,html:!0},disable=["image","heading"],stretching_timeout=1e4,stretching_time=0;scope.do_strech=function(){var els=element.find("iframe").width("100%").height("100%").attr("height","100%");stretching&&$timeout.cancel(stretching),els.length?(element.css("opacity",1),console.log("embedit :: iframe Stretched.")):stretching_time>stretching_timeout?console.warn("embedit :: skipping stretching iframe, time exceeded."):(console.log("embedit :: iframe not found, but stretch is set to true. Calling do_stretch again in a few ms..."),stretching=$timeout(scope.do_strech,300),stretching_time+=300)},scope.render=function(language){if(scope.embedit){if(language&&"object"==typeof scope.embedit)var altlanguage=_.filter(scope.embedit,_.identity).pop(),contents=scope.embedit[language]||scope.embedit.en_US||altlanguage||"";else contents=scope.embedit;if(attrs.excerpt&&(contents=$filter("tokenize")(contents,parseInt(attrs.excerpt)||32)),attrs.markdown){var md=new window.markdownit(options).disable(disable);contents="inline"==attrs.markdown?md.renderInline(contents):md.render(contents)}else contents=contents.split(/[\n\r]+/).join("<br/>");if(scope.firstline&&(contents=contents.split(/<br\s?\/?>/).shift()),element.html(contents),scope.stretch&&scope.do_strech(),attrs.autoplay){var src=element.find("iframe").attr("src");element.find("iframe").attr("src",src+(src.indexOf("?")==-1?"?":"&")+"autoplay=1"),console.log("embedit :: Activating autoplay on iframe...",src)}}},scope.stretch,scope.language&&"object"==typeof scope.embedit?scope.$watch("language",scope.render):scope.$watch("embedit",scope.render)}}}),angular.module("miller").directive("footnote",function($compile,$rootScope,RUNTIME){return{restrict:"A",scope:{caption:"=",footnote:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/footnote.html",link:function(scope,element,attrs){var footnoteSl="#fn"+scope.footnote+" p",contents=$(footnoteSl).clone(),wrapper=element.find(".footnote-contents");wrapper.html(contents),$compile(wrapper.contents())(scope),scope.isOpened=!!attrs.isOpened,scope.toggleFootnote=function(){console.log("::footnote > toggleFootnote")},scope.fullsize=function(slug,type){scope.$parent.fullsize?scope.$parent.fullsize(slug,type):$log.error(":: footnote > fullsize is without hanlders.")}}}}),angular.module("miller").constant("LAZY",{QUALITY_HIFI:"hifi",QUALITY_SNAPSHOT:"snapshot"}).directive("lazyCover",function($log,$timeout,LAZY,RUNTIME){return{restrict:"A",templateUrl:RUNTIME["static"]+"templates/partials/directives/lazy-cover.html",scope:{media:"="},link:function(scope,element,attrs){scope.render=function(quality){if("video"==scope.media.type||"rich"==scope.media.type?scope.quality=LAZY.QUALITY_SNAPSHOT:scope.quality=attrs.quality||LAZY.QUALITY_HIFI,attrs.immediate&&(scope.immediate=!0),_.values(LAZY).indexOf(scope.quality)==-1)return void $log.error("lazy-cover: quality attribute should be one of these:",_.keys(LAZY),"- received:",attrs.quality);if("object"!=typeof scope.media)return void $log.error("lazy-cover: media attribute should be an object, received:",scope.media);switch(scope.media.data&&(scope.offsetx=scope.media.data.thumbnail_offset_x||"center",scope.offsety=scope.media.data.thumbnail_offset_y||"center"),scope.quality){case LAZY.QUALITY_HIFI:scope.src=scope.media.data?scope.media.data.media_url||_.get(scope.media,"metadata.urls.Publishable")||scope.media.data.thumbnail_url||scope.media.data.preview||scope.media.data.url||scope.media.attachment||scope.media.snapshot:scope.media.attachment||scope.media.snapshot;break;case LAZY.QUALITY_SNAPSHOT:scope.src=scope.media.data?scope.media.data.thumbnail_url||scope.media.data.preview||_.get(scope.media,"metadata.urls.Preview")||scope.media.snapshot||scope.media.attachment||scope.media.data.url:scope.media.snapshot||scope.media.attachment}$log.log("lazy-cover ready - src:",scope.src,"quality:",scope.quality)},$timeout(scope.render,0)}}}).directive("lazyImage",function($log){return{restrict:"A",scope:{src:"="},link:function(scope,element,attrs){function wakeup(){element.css({"background-size":attrs.size||"cover","background-position":"center center","background-repeat":"no-repeat","background-image":"url("+scope.src+")"}),element.find(".loading").hide()}$log.log(":::lazy on ",scope.src),element.addClass("lazy-box").css({"background-color":"#B7B2B2"}).html('<div class="loading">...</div>'),scope.$watch("src",function(v){v&&wakeup()})}}}).directive("lazyPlaceholder",function($log,$rootScope,$compile,LAZY,RUNTIME){return{scope:{},templateUrl:RUNTIME["static"]+"templates/partials/directives/lazy-placeholder.html",link:function(scope,element,attrs){var slug=element.attr("lazy-placeholder"),type=element.attr("type");scope.$parent.footnote?scope.quality=LAZY.QUALITY_SNAPSHOT:attrs.quality?scope.quality=attrs.quality:scope.quality=LAZY.QUALITY_HIFI,scope.type=type,scope.user=$rootScope.user,scope.language=$rootScope.language,$log.log("⏣ lazy-placeholder on type:",type,"- slug:",slug,"lang"),scope.complete=function(res){res?(scope.resolved=res,$log.log("⏣ lazy-placeholder resolved for type:",type,"- slug:",slug),$compile(element.contents())(scope)):$log.error("⏣ lazy-placeholder cannot find slug:",slug)},$rootScope.resolve&&"string"==typeof slug&&$rootScope.resolve(slug,type,scope.complete),scope.fullsize=function(slug,type){$rootScope.fullsize(slug,type)}}}}).directive("respectSibling",function($log,$timeout,$rootScope,EVENTS){return{scope:{update:"="},restrict:"A",link:function(scope,element,attrs){function setHeight(){$log.log("🚀 respect-next-sibling > setHeight()"),$timeout.cancel(p),p=$timeout(function(){var h="next"==_sibling?element.next()[0].offsetHeight:element.prev()[0].offsetHeight;element.height(Math.max(h,attrs.minHeight||300))},500)}$log.log("🚀 respect-next-sibling ready");var p,_sibling="next"==attrs.respectSibling?"next":"previous";setHeight(),angular.element(window).bind("resize",setHeight),$rootScope.$on(EVENTS.RESIZE,function(){setHeight()})}}}).directive("respectPreviousSibling",function($log,$timeout){return{scope:{update:"="},restrict:"A",link:function(scope,element,attrs){function setHeight(){$log.log("🚀 respect-previous-sibling > setHeight()"),$timeout.cancel(p),p=$timeout(function(){element.height(Math.max(element.prev()[0].offsetHeight,attrs.minHeight||300))},500)}$log.log("🚀 respect-previous-sibling ready");var p;setHeight(),angular.element(window).bind("resize",setHeight)}}}),angular.module("miller").directive("marginalia",function($log,$window,$timeout,CommentFactory,RUNTIME){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/marginalia.html",scope:{whenvisible:"&"},link:function(scope,element,attrs){var wh,t_delay=600,w=angular.element(window);scope.is_visible=!1;var evaluate=function(){var ot=element.offset().top,ws=w.scrollTop(),is_visible=wh+ws-200>ot;is_visible!=scope.is_visible&&(scope.is_visible=is_visible,is_visible&&scope.whenvisible()),$log.log("::marginalia -> evaluate() is_visible:",is_visible,"- wh:",wh,"- ws:",ws)},resize=function(){$log.log("::marginalia -> resize()"),wh=w.height()};$timeout(function(){resize(),evaluate(),w.scroll(_.debounce(evaluate,t_delay)),w.on("resize",_.debounce(resize,t_delay))},200),$log.log("::marginalia ready.")}}}),angular.module("miller").directive("markdownit",function($compile,$log,$location,markdownItService,EVENTS){return{restrict:"A",scope:{markdownit:"=",settoc:"&",setdocs:"&",language:"=",watchlanguage:"=",listener:"&"},link:function(scope,element,attrs){function parse(){if(!scope.markdownit||"object"!=typeof scope.markdownit&&!scope.markdownit.length)return void $log.warn(":: markdownit parse() without any markdown text! Check the value for `markdownit`");var results="object"==typeof scope.markdownit?scope.markdownit:markdownItService(scope.markdownit,scope.language);scope.resources=results.docs,element.html(results.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:results.ToC}),scope.setdocs&&scope.setdocs({items:results.docs}),scope.isReady=!0}var previousFocus;scope.isReady=!1,scope.hash=function(what){$location.hash(what)},scope.focus=function(idx){$log.log(":: markdownit > focus - idx:",idx),previousFocus&&previousFocus==idx&&scope.listener?(previousFocus=0,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:0}})):scope.listener&&(previousFocus=idx,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:idx}}))},scope.fullsize=function(slug,type){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_FULLSIZE,data:{slug:slug.replace(/^[^\/]*\//,""),type:type}})},scope.resolve=function(slug,type,notify){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_RESOLVE,data:{slug:slug,type:type},callback:notify})},!attrs.watchmarkdownit&&scope.watchlanguage&&scope.language?scope.$watch("language",function(language){language&&parse()}):attrs.watchmarkdownit?scope.$watch("markdownit",function(){parse()},!0):parse()}}}).directive("marked",function($compile,$log,$location,markedService){return{restrict:"A",scope:{marked:"=",settoc:"&",setdocs:"&",language:"="},link:function(scope,element,attrs){function init(){if(!scope.marked||!scope.marked.length)return void $log.warn(":: marked init(), no text to be marked");var rendered=markedService(scope.marked,scope.language);element.html(rendered.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:rendered.ToC}),scope.setdocs&&scope.setdocs({items:rendered.docs})}new marked.Renderer;scope.hash=function(what){$location.hash(what)},scope.miller=function(url){},scope.language?scope.$watch("language",function(language){language&&init()}):init()}}}),angular.module("miller").directive("codediff",function($log,angularLoad,RUNTIME){return{restrict:"A",scope:{raw:"=",diff:"="},template:"<div ng-class='{\"ready\": isReady}' id='versioned-contents'><textarea></textarea></div>",link:function(scope,el,attributes){scope.isReady=!1,$log.log("::codediff loading..."),angularLoad.loadScript(RUNTIME["static"]+"js/lib/simplemde.min.js").then(function(){$log.log("::codediff lib loading done.");var cm=CodeMirror.fromTextArea(el.find("textarea")[0],{lineNumbers:!1,readOnly:!0,lineWrapping:!0,mode:"markdown"});cm.setValue(scope.raw);var displayDiff=function(diff){if("object"!=typeof diff)return $log.log("::codediff -> displayDiff() no diff to display, codediff is ready."),void(scope.isReady=!0);$log.log("::codediff -> displayDiff()");var lovely=/\[\-(.+?)\-\]|\{\+(.+?)\+\}/g;for(var i in diff){$log.log("::codediff",i,diff[i]);for(var loffset=i.match(/\+(\d+)[,\d\s]+?@@$/)[1]-1,lines=diff[i].split(/\n/),j=0,jl=lines.length;j<jl;j++){var hasDiffs=lines[j].match(lovely),line=loffset+j-1,contents=lines[j].replace(lovely,function(m,del,add){return del||add}),charoffset=0;for(hasDiffs&&(cm.replaceRange(contents,{line:line,ch:0},{line:line,ch:line.length}),cm.addLineClass(line,"wrap","mod"));null!=(match=lovely.exec(lines[j]));){var left=("undefined"!=typeof match[1],match.index-charoffset),right=match.index-charoffset+match[0].length-4;cm.doc.markText({line:line,ch:left},{line:line,ch:right},{className:"undefined"==typeof match[1]?"add":"del"}),charoffset+=4}scope.isReady=!0}}};scope.$watch("diff",displayDiff),$log.log("::codediff ready.")})}}}).directive("mde",function($log,$timeout,$modal,$filter,DocumentFactory,StoryFactory,markdownItService,angularLoad,RUNTIME){return{restrict:"AE",scope:{mde:"=",settoc:"&",setdocs:"&",setmarked:"&",language:"=",diffs:"=",clearcontent:"&"},templateUrl:RUNTIME["static"]+"templates/partials/directives/mde.html",link:function(scope,el,attributes){$log.log("::mde lib loading..."),angularLoad.loadScript(RUNTIME["static"]+"js/lib/simplemde.min.js").then(function(){function init(){function moveCurrentBlock(pos){var blockIndex=0;if(blockIndex!=currentBlockIndex&&(currentBlock&&currentBlock.removeClass("active"),currentBlock=contents.children().eq(blockIndex),currentBlock.length)){currentBlock.addClass("active");currentBlock[0].offsetTop,simplemde.codemirror.charCoords({line:pos.line,ch:0},"local").top}}function move(){timer&&clearTimeout(timer),timer=setTimeout(function(){simplemde.codemirror.display.cursorDiv.firstChild&&(cursor={top:simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,left:simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,height:simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight},wand.css("transform","translateY("+(cursor.top+cursor.height)+"px)"),followCursor&&toolbox.css("transform","translate("+cursor.left+"px,"+cursor.top+"px)"),pos=simplemde.codemirror.getCursor("start"),stat=simplemde.codemirror.getTokenAt(pos),moveCurrentBlock(pos),scope.activeStates=(stat.type||"").split(" "),scope.$emit("mde.activestates",scope.activeStates),scope.$apply())},20)}function beforeSelectionChange(e,sel){var isSelection=sel.ranges[0].head.ch-sel.ranges[0].anchor.ch!==0;isSelection&&isSelection!=_isSelection?toolbox.addClass("active"):isSelection||isSelection==_isSelection||toolbox.removeClass("active"),_isSelection=isSelection}function recompile(){var marked=markdownItService(simplemde.value(),!1,!0),ToCHash=md5(JSON.stringify(marked.ToC)),docsHash=md5(_.map(marked.docs,"slug").join("--"));_ToCHash!=ToCHash&&($log.log("::mde -> recompile() items ToC:",marked.ToC.length,"docs:",marked.docs.length,ToCHash),scope.settoc({items:marked.ToC})),_docsHash!=docsHash&&($log.log("::mde -> recompile() items docs:",_docsHash),scope.setdocs({documents:marked.docs})),scope.setmarked({marked:marked}),_ToCHash=ToCHash,_docsHash=docsHash,move()}function onUpdate(e){var value=simplemde.value();textarea.val()!=value&&(scope.mde=value,textarea.val(value)),move(),timer_recompile&&clearTimeout(timer_recompile),timer_recompile=setTimeout(function(){recompile(),scope.$apply()},100)}function onChange(e,change){var from=change.from,text=change.text.join("\n"),to=(change.removed.join("\n"),simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from)+text.length));simplemde.codemirror.markText(from,to,{className:"mde-modified"})}function beforeChange(){}textarea.show(),wand.show(),toolbox.show(),simplemde=new SimpleMDE({element:textarea[0],spellChecker:!1,status:!1,toolbar:!1,toolbarTips:!1,initialValue:scope.mde}),scope.clear=function(){confirm("You are about to remove the content of your article. Continue?")&&(simplemde.value(""),scope.mde="",scope.clearcontent())};var cursor,pos,stat,followCursor,currentBlock,_isSelection,_ToCHash,_docsHash,currentBlockIndex=-1;simplemde.codemirror.on("update",onUpdate),simplemde.codemirror.on("cursorActivity",move),simplemde.codemirror.on("beforeSelectionChange",beforeSelectionChange),simplemde.codemirror.on("beforeChange",beforeChange),simplemde.codemirror.on("change",onChange),scope.settoc&&(timer_recompile=setTimeout(recompile,20))}$log.log("::mde lib loading done."),scope.activeStates=[],scope.isReady=!0,scope.isPreviewEnabled=!1,$log.log("::mde @link, language:",scope.language);var simplemde,timer,timer_recompile,timer_preview,wand=el.find(".wand").hide(),textarea=el.find("textarea").hide(),toolbox=el.find(".toolbox").hide(),contents=$("#contents"),referenceModal=$modal({scope:scope,title:"h",controller:"EnrichModalCtrl",template:RUNTIME["static"]+"templates/partials/modals/mde-enrich.html",show:!1});scope.setTab=function(tab){scope.tab=tab},scope.tab="CVCE",scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),scope.suggestMessage="(loading...)"},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),!1)};scope.suggestResults=[],scope.suggestMessage="",scope.suggest=function(query,service){if($log.log("::mde -> suggest()",scope.query,query),query.length<3)return scope.suggestMessage="(write something more)",void(scope.suggestResults=[]);if(scope.lookups=[],scope.count=0,scope.next=void 0,scope.suggestMessage="(loading...)","favourite"==service)return void DocumentFactory.get({filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.lookups=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"});if("glossary"==service){var params={tags__slug:"glossary"};return query.length>2&&(params.contents__icontains=query),void StoryFactory.get({filters:JSON.stringify(params)},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.glossary=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"})}},scope.showReferenceModal=function(){return scope.activeStates.indexOf("link")!==-1?void $log.warn("oh dear, you should not click on it"):void referenceModal.$promise.then(function(){$log.log("::mde -> showReferenceModal called"),referenceModal.show()})},scope.addDocument=function(type,contents,reference,url,embed){var slug;return $log.debug("::mde -> addDocument() type:",type),"bibtex"==type?void $log.debug("    reference:",bibtexParse.toJSON(reference)):"glossary"==type?(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"voc/"+scope.selectedDocument.slug})):("crossref"==type&&(embed=angular.extend({type:type},scope.selectedDocument||{}),url=embed.doi,$log.debug("::mde -> addDocument() embed:",embed)),"url"==type||"crossref"==type?embed.title?(slug=$filter("slugify")(embed.title).substr(0,100),reference&&(embed.bibtex=reference),void DocumentFactory.save({title:embed.title,data:embed,type:(embed.type||"link").toLowerCase(),url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),"crossref"==type?simplemde.codemirror.replaceSelection(simplemde.codemirror.getSelection()+"\n\n"+embed.fullCitation+" [doi](doc/"+res.slug+")\n\n"):SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&"slug"==_.keys(err.data).join("")?"crossref"==type?simplemde.codemirror.replaceSelection(simplemde.codemirror.getSelection()+"\n\n"+embed.fullCitation+" [doi](doc/"+slug+")\n\n"):SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}):$log.error("::mde -> addDocument() cannot save document",err)})):(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:url})):scope.selectedDocument?"CVCE"==type?(slug="cvce-"+scope.selectedDocument.details.doi,$log.debug("::mde -> addDocument() doc:",slug),void DocumentFactory.save({title:scope.selectedDocument.title,data:scope.selectedDocument,type:(scope.selectedDocument.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&($log.debug("::mde -> addDocument() document already saved:",slug),SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}))})):("bibtex"==scope.selectedDocument.type&&SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug}),$log.debug("::mde -> addDocument() doc:",scope.selectedDocument),referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug})):void $log.warn("::mde -> addDocument() no document selected"))},scope.selectDocument=function(doc){$log.log("::mde -> selectDocument()",doc.id),scope.selectedDocument&&scope.selectedDocument.id==doc.id?(scope.isSomethingSelected=!1,scope.selectedDocument=!1):(scope.isSomethingSelected=!0,scope.selectedDocument=angular.copy(doc))},scope.$on("mde.toolbox",function(event,data){scope.action(data.action)}),scope.action=function(action){"togglePreview"==action&&(scope.isPreviewEnabled=!scope.isPreviewEnabled),SimpleMDE[action](simplemde)},$timeout(init,50)})}}}),angular.module("miller").directive("rangy",function($log,$rootScope,angularLoad,RUNTIME,EVENTS){return{restrict:"AE",templateUrl:RUNTIME["static"]+"templates/partials/directives/rangy.html",scope:{actor:"=",target:"=",highlights:"=",forwardCommented:"&commented"},link:function(scope,element,attrs){if(!attrs.container)return void $log.error("💾 rangy directive needs a container scope babe.");var container=angular.element("#"+attrs.container);document.getElementById(attrs.container);scope.isEnabled=!1,scope.serializedHighlights={},scope.commentsSelected=[],scope.commented=function(err,comment){return err?void $log.log("💾 rangy > commented() received an error:",err):($log.log("💾 rangy > commented() success:",comment),void scope.forwardCommented({error:err,comment:comment}))},scope.discarded=function(){$log.log("💾 rangy > discarded()"),scope.highlight&&(scope.highlight=null),$rootScope.rangy.highlighters.highlight.removeAllHighlights(),scope.hide()},scope.show=function(event){var offset=container.offset(),left=window.innerWidth-510-offset.left;element.css({"z-index":10,position:"absolute",top:event.pageY-offset.top,left:left}),scope.isEnabled=!0,scope.$apply()},scope.hide=function(){scope.isEnabled=!1,previousSelectedHighlight&&previousSelectedHighlight.removeClass("active"),scope.$apply()};var previousSelectedHighlight;$log.log("💾 rangy lazy loading rangy lib ... on: #"+attrs.container),angularLoad.loadScript(RUNTIME["static"]+"js/scripts.rangy.min.js").then(function(){function createHighlighter(classname){if($rootScope.rangy.highlighters[classname])return $rootScope.rangy.highlighters[classname];var h=rangy.createHighlighter();return h.addClassApplier(rangy.createClassApplier(classname,{ignoreWhiteSpace:!0,tagNames:["span","a"],exclusive:!0})),$rootScope.rangy.highlighters[classname]=h,
h}function toggleFocus(el){previousSelectedHighlight&&previousSelectedHighlight.removeClass("active"),previousSelectedHighlight=el,previousSelectedHighlight.addClass("active")}function onEscapeKey(e){27===e.keyCode&&onBodyClick()}function onBodyClick(){$log.log("💾 rangy @onBodyClick"),scope.highlight&&scope.discarded(),scope.hide(),scope.$apply()}function onQuoteClick(event){var focus=event.currentTarget.getAttribute("rangy-highlight"),el=angular.element("#"+attrs.container).find("."+focus),top=el.offset().top;$log.log("💾 rangy div[rangy-highlight]@click, focus:",focus,"- scrollTop:",top-window.innerHeight/3),$("body,html").stop(!0,!0).animate({scrollTop:top-window.innerHeight/3},"360","swing",function(){}),toggleFocus(el),scope.commentsSelected=_.uniq(el[0].className.split(" ").concat([focus])),scope.show({pageY:top}),scope.$apply()}function onHighlightClick(event){toggleFocus($(event.currentTarget)),rangy.getSelection().isCollapsed?($log.log("💾 rangy span[hl]@click, no selection, view comment:",event.currentTarget.className),event.stopImmediatePropagation(),scope.commentsSelected=event.currentTarget.className.split(" ")):$log.log("💾 rangy span[hl]@click with selection"),scope.show(event),scope.$apply()}$log.log("💾 rangy lib loading done; rangy.initialized:",rangy.initialized),rangy.initialized||rangy.init(),$rootScope.rangy||($rootScope.rangy={},serializeHighlight=function(highlight){var h=this,characterRange=highlight.characterRange;return"type:"+h.converter.type+"|"+[characterRange.start,characterRange.end,highlight.id,highlight.classApplier.className,highlight.containerElementId,JSON.stringify(highlight.attrs)].join("$")}),$rootScope.rangy.highlighters||($rootScope.rangy.highlighters={},$rootScope.rangy.highlighters.highlight=rangy.createHighlighter(document,"TextRange"),$rootScope.rangy.highlighters.highlight.addClassApplier(rangy.createClassApplier("highlight",{ignoreWhiteSpace:!0,tagNames:["span","a"]}))),scope.prepareSelectedText=function(event){if(rangy.getSelection().isCollapsed)return $log.log("💾 rangy > prepareSelectedText() nothing selected..."),scope.highlight&&scope.discarded(),void scope.hide();scope.highlight&&$rootScope.rangy.highlighters.highlight.removeAllHighlights(),scope.commentsSelected=[],scope.show(event);var h=$rootScope.rangy.highlighters.highlight.highlightSelection("highlight",{containerElementId:attrs.container});h[0].attrs={hl:""},scope.highlight={h:h[0],s:$rootScope.rangy.highlighters.highlight.serializeHighlight(h[0])},$log.log("💾 rangy > prepareSelectedText() serialized:",scope.highlight.s)},scope.renderHighlights=function(serializeds){serializeds.forEach(function(d){var h,id=d.split("$")[3];id.length&&!scope.serializedHighlights[id]&&($log.log("rangy create highlighter"),h=createHighlighter(id),h.deserialize(d),scope.serializedHighlights[id]=h.highlights[0].characterRange)}),$log.log("💾 rangy -> renderHighlights() serializedHighlights:",scope.serializedHighlights)},container.on("click","[hl]",onHighlightClick),container.on("click",scope.prepareSelectedText),$(document).on("click","div[rangy-highlight]",onQuoteClick),$(document).keyup(onEscapeKey),$rootScope.$on(EVENTS.SOCKET_USER_COMMENTED_STORY,function(event,data){if(data.target.id==scope.target.id&&data.info.comment.highlights&&(scope.commentsSelected.length||scope.highlight)){$log.log("💾 rangy @EVENTS.SOCKET_USER_COMMENTED_STORY");var commentRange=data.info.comment.highlights.match(/\|(\d+)\$(\d+)\$/),sample=scope.commentsSelected.length?scope.serializedHighlights[scope.commentsSelected[0]]:scope.highlight.h.characterRange;commentRange[1]>=sample.start&&commentRange[2]<=sample.end&&scope.commentsSelected.push(data.info.comment.short_url)}}),$rootScope.$on(EVENTS.RANGY_FOCUS,function(event,focus){var el=angular.element("#"+attrs.container).find("."+focus);if(el.length){var top=el.offset().top;$log.log("💾 rangy @EVENTS.RANGY_FOCUS focus:",focus,"- scrollTop:",top-window.innerHeight/3),$("body,html").stop(!0,!0).animate({scrollTop:top-window.innerHeight/3},"360","swing",function(){}),toggleFocus(el),scope.commentsSelected=_.uniq(el[0].className.split(" ").concat([focus])),scope.show({pageY:top})}}),$rootScope.$on(EVENTS.SOCKET_USER_UNCOMMENTED_STORY,function(event,data){}),$rootScope.$on(EVENTS.RANGY_REFRESH,function(event){$log.log("💾 rangy @RANGY_REFRESH"),scope.highlights&&scope.highlights.length&&scope.renderHighlights(scope.highlights)}),scope.$watchCollection("highlights",function(highlights){highlights&&highlights.length?scope.renderHighlights(highlights):$log.log("💾 rangy @highlights no highlights found.")}),scope.$on("$destroy",function(){$log.log("💾 rangy @$destroy...")})})["catch"](function(){$log.warn("💾 rangy lib error","ooooo")})}}}),angular.module("miller").directive("rating",function(){return{restrict:"EA",template:'<ul class="star-rating" ng-class="{readonly: readonly}">  <li ng-repeat="star in stars" class="star" ng-class="{filled: star.filled}" ng-click="toggle($index)">    <i class="icon icon-star"></i>  </li></ul>',scope:{ratingValue:"=ngModel",max:"=?",onRatingSelect:"&?",readonly:"=?"},link:function(scope,element,attributes){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({filled:i<(scope.ratingValue||0)})}void 0==scope.max&&(scope.max=5),scope.toggle=function(index){if(void 0==scope.readonly||scope.readonly===!1){scope.ratingValue=index+1,"function"==typeof scope.onRatingSelect&&scope.onRatingSelect({rating:index+1});for(var i in scope.stars){if(!(i<scope.ratingValue))break;scope.stars[i].filled=!0}}},scope.$watch("ratingValue",function(oldValue,newValue){newValue&&updateStars()}),updateStars()}}}),angular.module("miller").directive("richOembed",function($sce,$log,$timeout,RUNTIME){return{restrict:"A",scope:{enabled:"=",oembed:"=",media:"=",autoplay:"=",fullscreen:"&"},templateUrl:RUNTIME["static"]+"templates/partials/directives/rich-oembed.html",link:function(scope,element,attrs){var timer;scope.iframeEnabled=!1,scope.quality=attrs.quality,scope.immediate=void 0!=typeof attrs.immediate,$log.log("🍩 rich-oembed ready, media:",scope.media,"- autoplay:",scope.autoplay,"- quality:",scope.quality),scope.$watch("enabled",function(v){$log.debug("🍩 rich-oembed @enabled:",v),scope.toggleEnable(!!v)}),scope.toggleFullscreen=function(){$log.debug("🍩 rich-oembed > toggleFullscreen:",typeof scope.fullscreen),scope.fullscreen()},scope.toggleEnable=function(enabled){$log.log("🍩 rich-oembed > toggleEnable()",enabled);var v=void 0===enabled?!scope.iframeEnabled:enabled;timer&&$timeout.cancel(timer),timer=$timeout(function(){$log.log("🍩 rich-oembed apply iframeEnabled:",v),scope.iframeEnabled=v},100)}}}}),angular.module("miller").directive("slides",function($log,$timeout,$rootScope){return{link:function(scope,element,attrs){scope.isVertical=!!attrs.vertical,scope.currentIndex=0,scope.numSlides=[0,1,2],scope.currentHeight=0,scope.currentOffset=0;var timer,UP=-1,DOWN=1;scope.direction=DOWN,scope.loop=function(){scope.direction==DOWN&&scope.currentIndex==scope.numSlides.length-1?scope.direction=UP:scope.direction==UP&&0==scope.currentIndex&&(scope.direction=DOWN);var index=scope.currentIndex+scope.direction;scope.jumpTo(index)},scope.next=function(){scope.jumpTo(scope.currentIndex+1)},scope.prev=function(){scope.jumpTo(scope.currentIndex-1)},scope.jumpTo=function(index){return scope.isDOMready?(index=Math.max(Math.min(index,scope.numSlides.length-1),0),void(index!=scope.currentIndex&&(scope.currentIndex=index,scope.slide()))):void $log.warn("No RAIL FOUND")},scope.pause=function(){timer&&$timeout.cancel(timer)},scope.play=function(){timer&&$timeout.cancel(timer),"undefined"!=typeof attrs.autoscroll&&(timer=$timeout(scope.loop,3e3))},scope.slide=function(){var slide=element.find(".slide").get(scope.currentIndex);scope.currentHeight=slide.clientHeight,scope.currentOffset=slide.offsetTop,attrs.adapt&&element.height(scope.currentHeight),$rootScope.$emit("lazyImg:refresh"),timer&&$timeout.cancel(timer),"undefined"!=typeof attrs.autoscroll&&(timer=$timeout(scope.loop,6e3))},$timeout(function(){scope.isDOMready=!0,$rootScope.$emit("lazyImg:refresh"),$log.log("slides ready!"),scope.slide()},0)}}}),angular.module("miller").directive("slidingSteps",function($log,$rootScope,RUNTIME,$timeout){return{restrict:"A",scope:{items:"=",focus:"=",language:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/sliding-steps.html",link:function(scope,element,attrs){function scrollTo(to,callback,duration){function move(amount){document.documentElement.scrollTop=amount,document.body.parentNode.scrollTop=amount,document.body.scrollTop=amount}function position(){return document.documentElement.scrollTop||document.body.parentNode.scrollTop||document.body.scrollTop}var start=position(),change=to-start,currentTime=0,increment=20;duration="undefined"==typeof duration?360:duration;var animateScroll=function(){currentTime+=increment;var val=easeInOutQuad(currentTime,start,change,duration);move(val),currentTime<duration?requestAnimFrame(animateScroll):callback&&"function"==typeof callback&&callback()};animateScroll()}$log.log("⏣ sliding-steps ready, items.length:",_.map(scope.items,"_index"),scope.items.length,scope.items);var lastIdxSelected,sideOffset=0,refOffset=0,parentOffset=element.offset().top,steps=element.find(".sliding-steps"),stepswrapper=steps.parent(),stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,translateY=0;scope.user=$rootScope.user;var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}(),easeInOutQuad=function(t,b,c,d){return t/=d/2,t<1?c/2*t*t+b:(t--,-c/2*(t*(t-2)-1)+b)};scope.reach=function(idx,sideoffset,refOffset,step){stepswrapperHeight=stepswrapper[0].offsetHeight,stepsHeight=steps[0].offsetHeight;var expectedOffset=refOffset-sideoffset,visibleOffset=-(sideoffset+step[0].offsetHeight-stepswrapperHeight);$log.log("⏣ sliding-steps > reach idx:",idx,"- side offset:",sideoffset,"- ref offset:",refOffset,"- parentOffset:",parentOffset,"- expectedOffset:",expectedOffset,"- visibleOffset:",visibleOffset,"- step[0].offsetHeight: ",step[0].offsetHeight),translateY=Math.min(expectedOffset,visibleOffset),steps.css("transform","translateY("+translateY+"px)"),scope.isMoreTop=expectedOffset<-2,scope.isMoreBottom=stepsHeight+translateY>stepswrapperHeight},scope.prev=function(){$log.log("⏣ sliding-steps > prev - idx:",lastIdxSelected,"- isMoreTop:",scope.isMoreTop),scope.isMoreTop&&(steps.children().each(function(i,d){return d.offsetTop+translateY>0?(console.log("...",target),!1):void(target=+d.id.replace("step-",""))}),target&&scope.alignTo(target))},scope.next=function(){$log.log("⏣ sliding-steps > next - idx:",lastIdxSelected,"- steps",steps),steps.children().each(function(i,d){return i<lastIdxSelected||(console.log("...",d.offsetTop+d.offsetHeight+translateY,stepswrapperHeight,d.offsetTop+d.offsetHeight+translateY<stepswrapperHeight),d.offsetTop+d.offsetHeight+translateY>stepswrapperHeight?(scope.alignTo(+d.id.replace("step-","")),!1):void 0)})},scope.isMoreTop=!1,scope.isMoreBottom=stepsHeight>stepswrapperHeight,scope.fullsize=function(slug,type){$log.log("⏣ sliding-steps > fullsize slug:",slug),$rootScope.fullsize(slug,type)},scope.align=function(idx,_sideOffset,_refOffset){var item=angular.element("#item-"+idx),step=element.find("#step-"+idx);return sideoffset=_sideOffset||step[0].offsetTop,refOffset=_refOffset||item[0].offsetTop,lastIdxSelected==idx-1?void scope.reset(item):(void 0!==lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active")),item.addClass("active"),lastIdxSelected=idx-1,scope.items[idx-1].isFocused=!0,void scope.reach(idx,sideoffset,refOffset,step))},scope.reset=function(){lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active"),lastIdxSelected=void 0)},scope.alignTo=function(idx){$log.log("⏣ sliding-steps > alignTo -idx:",idx);var step=element.find("#step-"+idx);sideOffset=step[0].offsetTop,refOffset=angular.element("#item-"+idx)[0].offsetTop;var wrapperOffset=element.parent().offset().top;$log.log("⏣ sliding-steps > alignTo idx:",idx,"- side offset:",sideOffset,"- ref offset:",refOffset,"- win height:",window.innerHeight/3,"- parentOffset:",parentOffset,"- current scrollY:",window.scrollY),scrollTo(refOffset+wrapperOffset-window.innerHeight/2),scope.align(idx,sideOffset,refOffset,step)},scope.$watch("focus",function(idx){idx?($log.log("⏣ sliding-steps @focus - idx:",idx,scope.items[idx-1]),scope.align(idx)):0===idx&&scope.reset()}),scope.$watch("items",function(items){items&&items.length&&($log.log("⏣ sliding-steps @items",items),scope.items=items)}),$timeout(function(){stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,scope.isMoreBottom=stepsHeight>stepswrapperHeight},1e3)}}}),angular.module("miller").directive("sticky",function($log,$window,$timeout){return{restrict:"AE",scope:{},link:function(scope,element,attrs){var w=angular.element(window),pl=angular.element('<div class="sticky-placeholder"></div>'),offsetTop=parseInt(attrs.offset||100),_is_bottom_visible=!0,_is_top_visible=!1;pl.insertBefore(element),scope.is_top_visible=!1;var resize=function(){wh=w.height(),evaluate()},evaluate=function(){var ot=pl.offset().top,ws=w.scrollTop();_is_bottom_visible=wh+ws>ot,_is_top_visible=ws+offsetTop<ot,scope.is_top_visible!=_is_top_visible&&(_is_top_visible?element.removeClass("top-sticky"):element.addClass("top-sticky"),scope.is_top_visible=_is_top_visible),scope.is_visible!=_is_bottom_visible&&(_is_bottom_visible?element.removeClass("sticky"):element.addClass("sticky"),scope.is_visible=_is_bottom_visible)};$timeout(function(){w.on("scroll",evaluate),w.on("resize",resize),resize()},200),scope.$on("$destroy",function(){w.off("scroll",evaluate),w.off("resize",resize),$log.log("::sticky killed.")})}}});